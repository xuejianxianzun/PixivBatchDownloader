# CHANGLOG

----------

下载时遇到404错误不重试

----------

轻提示改为调用方法，预设几个方法

--------

颜色值名称修改 如 green

## 9.x.x 2021/02/xx

### 新增“导入抓取结果”功能

下载器导出的结果可以被导入并进行下载。

你的抓取结果可以分享给其他人进行下载；你也可以导出抓取结果留待以后随时下载；或者用一台设备抓取，之后在另一台设备上进行下载。

某些情况下会是很有用的功能，不过大多数时间都没啥用吧（笑

**注意**：
1. 抓取结果里不包含这些命名数据：`{p_title}`, `{p_tag}`, `{task_date}`。导入抓取结果之后，这些标记依然可以使用，但它们可能和你导出抓取结果时的数据不同，需要注意。
2. 抓取结果里不包含进度信息，所以导入之后下载器会重新开始下载，不能从中间开始下载。（你可以编辑导出的文件，删除不想下载的文件数据）。

### 优化收藏页面的抓取效率

在获取作品列表时就使用过滤器进行检查，尽早过滤掉不符合条件的作品。

此外，在获取作品列表的过程中显示了作品数量，优化了提示。

### 代码优化

#### IndexPage 改名为 HomePage

#### 使用 enum 描述页面类型

在 `PageType` 类里添加了 enum 类型的 `PageName` 来描述页面类型及其数字编号的对应顺序。

这样在使用页面类型时，可以通过页面名字来引用它所代表的数字编号。示例：

```javascript
// old
if(pageType.type === 1){}

// new
if(pageType.type === pageType.list.Artwork){}
```

这样不仅易于理解，而且也便于修改。因为 `PageName` 相当于数据源，它维护着页面名称和编号的对应关系，其他模块都是通过它来获取编号，所以修改页面类型编号的话只需要修改它，其他模块不需要任何修改。（不过因为 `settings.wantPageArr` 是使用页面的编号来储存数据的，所以为了保持兼容性，不能更改 `PageName` 里的编号顺序）

#### 使用 enum 描述用户主页里的子页面类型

在 `InitUserPage` 里添加了 `ListType` 的 enum 类型描述。

#### 抓取结果里的 rank 数据类型从 string 改成 number

以前抓取结果里保存的 rank 是 '#1' 这样的字符串，这样不好。

现在把 rank 改为数字类型，'#' 号在获取文件名的时候再加上。

### 其他优化

### Star

*2021/01/29 Github 仓库达到 1K star*

## 9.0.2 2021/01/27

### 添加了一些提示

1. 安装下载器后，第一次打开 Pixiv 页面会提示如何使用：“点击页面右侧的蓝色按钮可以打开下载器面板。”
2. 命名规则下面显示如何建立文件夹的提示。以前这个提示需要点击命名规则右侧的问号才会显示，现在直接显示出来。
3. 下载完成后显示一条提示消息。
4. 批量添加收藏完成之后会显示提示。

### 把一些对话框提示改成了轻提示

一些提示不需要用户确认，甚至看不到也无所谓。

之前大部分提示都是使用对话框的，需要用户点击确认按钮。现在把一些提示改成轻提示，这样就不需要用户进行任何操作。

## 9.0.1 2021/01/24

### 修复了在作品页面内快速收藏时没有自动添加 tag 的问题

原本快速收藏是从页面上获取 tag 列表的，但是这两天 P 站进行了改版，导致获取不到 tag，所以失效了。

现在改成了从 api 请求作品的数据，然后提取 tag 列表。这样不会因为页面改版而失效。

之前从页面上获取 tag 是因为这样不用发送一次网络请求，比较快。不过现在也还好，因为图片查看器会先加载一遍作品的数据，所以快速收藏时的请求是从缓存获取的，花费的时间并没有明显增加。

## 9.0.0 2021/01/23

### 新增设置：在作品缩略图上显示放大图标

鼠标经过作品缩略图时，会在缩略图右上角显示一个放大图标，点击可以打开图片查看器，直接查看作品的大图。

你可以设置查看的图片尺寸是原图还是中等尺寸。（默认选择中等尺寸的图片，以便图片可以更快的显示出来）

缩略图的选择器列表：

`div[width="136"]`   小尺寸作品列表，主要出现在作品页内作品下方的作品列表，以及收藏作品后出现的推荐作品

`div[width="184"]`    中尺寸作品列表，全站通用

`div[width="288"]`  大尺寸作品列表，主要出现在首页“每日排行榜”区域

`._work`            旧版页面的通用作品列表，基本上所有旧版页面都在使用，但是尺寸有所不同

`figure > div`    关注用户的新作品页面，发现页面

### 优化图片查看器

#### 添加了下载按钮

在图片查看器里添加了下载按钮，可以直接下载当前作品。

提示：

1. 查看器显示的图片尺寸不会影响下载时的图片尺寸。这两个设置没有关联。
2. 当你从查看器里建立下载时，下载途中不会显示下载面板，并且会自动开始下载，以避免影响到用户查看图片。如果你想查看下载进度，可以按 Alt + X 打开下载面板，或者退出看图模式。

#### 可以用方向键操作了

以前图片查看器不能用键盘操作，原因是按左右方向键时 Pixiv 会自动切换作品页面。

现在进行了优化，图片查看器可以用键盘操作了。当图片查看器显示时，按左右键不会让 Pixiv 自动切换页面。

主要的键盘操作：

* `ESC` 退出全屏模式；退出查看器
* `F` 进入全屏模式；退出全屏模式
* `D` 下载当前查看的作品
* `←` 切换到上一张图片
* `→` 切换到下一张图片
* `↑` 放大图片
* `↓` 缩小图片

#### 解决了切换图片时抖动的问题

以前切换图片时，图片会发生很短的抖动，全屏查看时更加明显。现在不会抖动了。

### 命名标记里添加了点赞数和浏览量

此功能由赞助者提供赞助。

点赞数：`{like}`

浏览量：`{view}`

### 优化 Pixiv 会员按热门度搜索时的速度

Pixiv 会员在搜索页面可以选择“按热门度排序”，获得的作品是大致按照收藏数量从高到低排列的。

如果此时用户设置了收藏数量要求，就可以在某个临界点，不再抓取后续作品（因为后续的都是收藏数量不满足要求的了）。

在这种情况下，下载器优化了抓取速度。

### 代码优化

#### 优化快速下载功能

把快速下载功能归纳到到了 `QuickDownload` 类里。

之前是哪个页面需要快速下载功能就在这个页面里添加对应的代码，现在快速下载功能是全局的，只需要在 `QuickDownload` 里面定义在哪些页面启用它就行了。

#### 统一管理页面的 destroy 函数

下载器在每个页面上都可能会添加元素，绑定事件。当离开这个页面时应该销毁这些元素和事件，这就是 destroy 函数。

之前 destroy 函数的管理不太好，导致了一些问题，现在建立 `DestroyManager` 类来统一管理所有页面的 destroy 函数。

#### EVT 类添加了 bindOnce 方法

通过 `bindOnce` 只绑定某个事件一次，用于防止事件重复绑定。

需要注意的是，它绑定的事件可以执行多次，不会自动解绑。所以这个方法叫做 `bindOnce` 而不是 `once`，后者是只执行一次的意思。

#### 优化了 ImgViewer 类

ImgViewer 类以前只在作品页面内使用，内部配置是固定死的，现在为了让“在作品缩略图上显示放大图标”功能也可以使用它，对它进行了修改，添加了配置参数，优化了内部流程。

#### 添加了 Loading 类

通过修改它的 `show` 属性为 `true` 或者 `false`，可以用它来显示一个 loading 动画。

#### 添加了 Toast 类

用于显示轻量的提示。

#### 添加了 IdListWithPageNo 类

这是为了解决需要抓取多个列表页面时，获得的 id 数据顺序混乱的问题。

例如在搜索页面，下载器会一次抓取多个页面，但是由于网络请求的耗时是不固定的，所以这些请求返回的顺序并不符合发送顺序。

如下为某次测试的结果，同时抓取 10 个页面，返回的页面的顺序如下：

```
10
5
1
7
9
3
2
6
4
8
```

之前在每个页面返回后都立即把 id 数据存入 store，这样 id 数据的顺序是乱的。

现在添加了 IdListWithPageNo 类解决这个问题，使 id 数据保持正确的顺序。

#### 添加了 VipSearchOptimize 类

当 Pixiv 会员使用按热门度排序搜索时，进行优化。

目前只在插画、漫画搜索页面启用。其他页面不适合这个情况。

优化的原理：当会员使用热门度排序时，Pixiv 返回的数据是按收藏数量从高到低排序的。

但是 Pixiv 返回的数据并不是严格按照收藏数量排序的，经常有一些作品顺序不对。如下：

```
作品 id   收藏数量
86825642  10356
86327501  10122
86849274  10805
87125991  9865
85997617  9849
87053323  10254
```

如下两个作品的数据，第一个都低于第二个，但是却排在第二个的前面。

```
87125991 点赞、收藏、浏览 6,322 - 9,868 - 29,857
87053323 点赞、收藏、浏览 7,112 - 10,254 - 33,441
```

所以为了解决这个问题，设置了一个数字：连续多少个作品未达到要求时，停止抓取。这是一个猜测值，大部分情况下应该没问题。

### 其他优化

#### 修复 bug

修复了抓取途中设置 quickDownload 或者 downloadFromViewer 会导致抓取之后的下载被错误影响的问题；

#### 当某些设置不合法时，修改为默认值

多图下载下载前几张图片不能小于 0，现在当这个设置的值不合法的时候，会自动修改为默认值。

### 单个用户的短时间内下载限制？

一位 Pixiv 会员告诉我，单个会员公平使用协议可能限制在 50GB 左右的短期抓取量 ，之后会发警告邮件。他就遇到过这个情况。

## 8.9.1 2021/01/07

### 在新版收藏页面里添加“给未分类作品添加 tag”

之前有段时间，Pixiv 的新版收藏页面里不显示非公开的作品，所以下载器去掉了这个按钮。

现在又可以用了，就添加回去了。

而且有用户说他的 pixiv 会从旧版收藏页面自动跳转到新版收藏页面，可能以后 Pixiv 会逐步停用掉旧版页面。

### 其他优化

在搜索页面如果用户在1000页之后的页码进行抓取，会显示提示：超出最大页码

## 8.9.0 2021/01/07

### 新增功能：针对特定用户屏蔽 tag

这个功能是由赞助者所赞助的。

Pixiv 本身有屏蔽 tag 功能，但它是屏蔽了所有用户的这个 tag，不能只针对某个用户屏蔽这个 tag。所以添加了这个设置。

### 新增功能：把 R-18(G) 作品存入指定的文件夹里

这个功能是由赞助者所赞助的。

如果你开启了这个选项，下载器就会把本次下载任务里的 R-18(G) 作品统一放到一个文件夹里。

下载器可以根据作品的 tag 判断这个作品是不是 R-18(G)。

**提示：**

1. R-18 和 R-18G 作品会放到同一个文件夹里；不能分开放到两个文件夹里。
2. 你可以修改使用的文件夹的名字。
3. 如果本次任务会建立文件夹，那么为 R-18(G) 作品建立的文件夹会放进任务文件夹里，成为子文件夹。

### 其他优化

#### 文本优化

#### 优化一些异常情况的提示

- 当用户在搜索页面 1000 页之后进行抓取时提示；
- 当用户在用户阻止列表里输入的用户 id 不是数字时提示；

## 8.8.0 2021/01/03

### 新增功能：保存用户头像和封面图片

在用户页面里添加了两个按钮，用于保存用户头像、封面图片。

当你处于用户页面里时，可以在“其他”选项卡里看到这两个按钮。

### 手动删除作品时，会显示一个指示图标

在搜索页面和发现页面可以使用“手动删除作品”。以前进入删除模式之后没有明显的提示，有时候会导致用户忘记现在处于删除模式之中，可能产生错误操作。

现在进入手动删除模式之后，会有一个红色的圆形图标跟随鼠标，表示这是在手动删除作品。

### 优化获取作品数据时的提示信息

优化了获取作品数据时的提示信息。

```
// 开始获取作品数据
开始获取作品信息

// 获取途中
待处理 42, 共抓取到 10 个作品

// 获取完毕
共抓取到 13 个作品
共抓取到 24 个文件
抓取完毕！
```

这样可以避免用户产生疑惑和焦虑，也便于了解抓取进度。

此外，之前在获取作品数据途中现实的是抓取到的文件数量，现在改为抓取到的作品数量。

### 优化 settings 里选项的值

以前有一些单选框，在 settings 里用数字代表它们的值，如

```
workDirName: '1' | '2'
// 1 代表使用 id 
// 2 代表使用命名规则
```

这样很不直观，所以新版本把数字直接改成了描述：

```
workDirName: 'id' | 'rule'
```

这样优化之后， settings 使用起来就更方便了。

用户如果本地保存有旧版本的设置，就会和新版本的设置不兼容，为此单独写了个类，把受影响的设置转换一下，进行兼容。

现在 settings 里储存的值，除了 `postDateStart` 和 `postDateEnd` 以外，都是最终值了，可以直接使用。

为什么这两个不是最终值呢？因为这两个储存的是时间，但是时间有多种表现形式（Date、string、number），结合实际情况，在 settings 用的是 number 类型存储它们。

### 拆分样式表

以前所有样式都放在 `style.less` 里，非常杂乱。现在拆分成多个 less 文件。

### 其他优化

- 优化了下载器在夜间模式里的 box-shadow 颜色。之前的颜色太不明显了。
- 修复了导入设置之后，子选项区域不会自动显示的问题。
- 搜索页面的“在结果中筛选”按钮改成了绿色。
- 调整了 LangText 里语言的顺序。现在的顺序是简中、繁中、英语、日语。
- 保存命名规则时，会通过对话框显示保存成功的消息。

## 8.7.0 2020-12-29

### 设置项“多图建立目录”变成“为作品创建单独的目录”

上个版本的“多图建立目录"允许设置超过多少张图片才建立目录。如果设置为 0，那么单图作品（1 张图片）也会建立一个目录。

也就是说“多图建立目录”已经不只是影响多图作品了，而是会影响所有作品。所以对这个选项进行了修改。

默认情况下，文件数量设置值为 1，所以只有多图会建立目录。你可以修改这个数字，达到不同的效果。

## 8.6.0 2020-12-28

### 多图建立目录时可以设置图片数量

增加了“图片数量大于 x”的设置。

之前“多图建立目录”开启后，如果从某个作品里下载的图片数量大于 1，就会自动建立文件夹。

但是有些用户想要设置其他数量，例如从作品里下载的图片数量大于 5 的时候才建立文件夹。所以增加了这个设置项。

### 图片比例设置里添加了正方形

以前设置里有横图、竖图，但是没有正方形，导致不能单独筛选正方形图片。

现在添加了正方形的设置。

### 优化手动选择作品的体验

#### 保留标记

之前手动选择了作品之后，如果切换了页面，选择的作品就没有标记了。现在进行了优化，页面切换后之后检查页面里是否含有被选择的作品，如果有就会再次给它添加标记。

例如在用户主页选择作品

https://www.pixiv.net/users/18095070

之后进入任意一个作品的页面，在作品图片下方会显示作品列表。可以看到选择的作品依然会被添加上标记。

#### 抓取之后不会清空选择的作品

现在抓取选择的作品之后，不会自动清空选择的作品。添加了一个按钮用于手动清空选择的作品。

之前当抓取了选择的作品之后，就会自动清空选择的作品。这有时候会带来一些不便，比如用户在抓取之后，想要修改筛选条件再次抓取，但此时选择的作品已经被清空，用只能了再选择一遍。所以现在不会自动清空了。

#### 性能问题

手动选择作品一般不会引起明显的性能问题，主要的资源占用是进入选择模式后，指示器（十字型光标）的动画效果会占用一部分 CPU 资源。不进入选择模式则无影响。

测试 CPU： G4600（双核四线程）

播放动画时，Chrome 资源管理器显示该页面的 cpu 使用率增加了约 30% 。这个数字是要平均到每个 cpu 线程的，每个线程增加了大约 7% 的使用率（睿频可能会升满，也可能不会）。

### 代码优化

#### 优化 settings 里的设置项的类型

某些设置应该是 `number` 类型或者 `array`，但是之前都是 `string`。这是个历史遗留问题，现在进行优化。

例如同时下载数量 `5` 使用 `number` 比较合理，但是之前是 string。过滤 tag 的设置应该是 `string[]`，但之前也是 string。这是因为以前设置项和表单耦合很紧密，而表单里的 input 元素的 value 都是 string，所以为了便于表单使用，很多设置都是 string 类型。

这导致 settings 里的某些设置并不是最终值，只是一个中间值。其他模块调用这些设置的时候经常需要自己解析，比如把 string 转换成 number 或者 string[]，很不方便。

这个版本在 `Settings.ts` 中添加了 `setSetting` 方法用来修改设置项。必须通过这个方法来修改设置项。这个方法对传递进来的值进行了解析和类型转换，这样其他模块可以直接使用 settings 里的设置项，不需要自己转换了。而且这样也兼容了旧版本的设置项。

以前有多个模块会触发 `settingChange` 事件，现在修改之后只有 `setSetting` 方法会触发这个事件，逻辑更加清晰。

对于 number 类型的设置，如果传递的值不合法，还会显示提示消息。

#### 优化 Filter 类

因为之前的 settings 里的某些选项是中间值，所以 Filter 类里会在合适的时机获取设置，计算一些选项的结果，并保存起来。

现在 settings 已经优化了，所以 Filter 类不再需要获取和保存设置，直接从 settings 读取即可。所以对  Filter 类做了对应的修改。

#### 把一些函数提取到 Tools 类

把一些与业务无关的工具函数提取到了 Tools 类里。

## 8.5.0 2020-12-23

### 添加“手动选择作品”的功能

在 Pixiv 的所有页面里都添加了这个功能。现在你可以手动选择页面上的任意作品进行下载！

打开下载面板就可以看到“手动选择作品“按钮，点击它就可以开始选择作品了。之后你也可以使用它来暂停选择、继续选择。（这个按钮对应的快捷键是 `Alt + S`）。

当你选择了一个作品之后，这个作品上会添加一个标记。

当你选择完毕之后，点击“抓取选择的作品”按钮进行抓取。

抓取之后，选择的作品会被清空，以便你可以开始新的选择。

**提示：**

- 你可以通过“暂停选择”、“继续选择”来进行多次选择，也可以在进入其他页面后继续选择。
- “抓取选择的作品”按钮会显示选择的作品数量。
- 下载器的过滤条件对手动选择的作品也会生效。所以你选择的某些作品可能不会被下载。
- 为防止误操作（因为点击作品链接会进入作品页面），进入选择模式之后，鼠标点击作品是不会进入作品页面的。如果你想进入作品页面，可以选择：1. 打开鼠标右键菜单，选择“在新标签页打开链接”；2. 点击“暂停选择”按钮（或按 `Esc` 键），停止选择作品。
- 当你进入其他页面时，**可能**会丢失选择的作品列表(*)。这时下载器会让浏览器提示你是否要离开此页面。如果你选择离开，就会丢失抓取的作品列表。

(*) 有时候进入某些页面是不需要重新加载网页的（浏览器的刷新按钮不会变化），这种情况下不会丢失已选择的作品。如果需要重新加载网页（浏览器的刷新按钮会发生变化），则会丢失已选择的作品。

### 其他优化

#### 一些页面的页数限制从 100 改为 250

关注的用户的新作品（插画和小说）页面之前页数限制是 100，但是最近发现 Pixiv 会员的页数有 250 页。所以现在修改页数限制为 250。

#### 抓取结果里添加了新的属性

在抓取结果里添加了以下属性：

```
likeCount
viewCount
commentCount
```

这主要是为了导出 CSV 和导出抓取结果时，里面可以包含这些数据。

#### 修复了抓取相同 id 的插画和小说时的问题

插画和小说的 id 可以是相同的，如：

https://www.pixiv.net/artworks/14287968

https://www.pixiv.net/novel/show.php?id=14287968

如果在一次抓取中遇到了相同 id 的插画和小说，以前只会保存先抓取到的，不会保存后抓取到的。现在对此进行了优化，都可以抓取和下载了。

断点续传和去重也能正常应对这种情况。

## 8.4.0 2020-12-19

### 优化“只下载已收藏”选项

“只下载已收藏”选项变成了另一个选项：

```
下载作品类型 ?  ✓ 未收藏   ✓ 已收藏 
```

你仍然可以实现“只下载已收藏”的效果。如有需要，也可以设置只下载未收藏。

-----------

### 收藏数量设置里增加了“日均收藏数量”

在设置收藏数量时，除了可以设置最小值、最大值，现在还可以设置“日均收藏数量”（默认未开启）。

日均收藏数量是 `收藏数 / 作品发布天数` 得到的。如果一个作品发布不足一天（如发布 2 小时，有 100 收藏），会按倍数补足到一天（日均收藏数量结果为 1200）。

如果设置了最小值、最大值，又同时设置了日均收藏数量，那么作品只要满足**两者中的任意一个条件**就会被下载。

**设计目的：优化对于新发布作品的抓取。**

例如我们在搜索一个 tag，因为想要高质量的作品，所以设置了收藏数量 `5000 - 999999`。有一些近期投稿的作品，虽然质量高，但因为发布时间短，收藏数量达不到 `5000`，就不会被抓取。

还是上面的例子，如果一个作品发布了 2 个小时，有 100 收藏，日均收藏数量为 1200。它不符合收藏数量 `5000` 的要求，但是如果你设置“日均收藏数量”为 `1000`，就可以抓取到这张图片。

**补充说明：不建议单独使用“日均收藏数量”。** 

在设置收藏数量时，你必须设置“最小值、最大值”。“日均收藏数量”是一个可选的设置，它应该作为补充的设置，而不是唯一的设置。

你可以通过某些方法单独使用“日均收藏数量”。首先把最小值、最大值设置为一个不可能的数字 `999999 - 9999999`，再设置“日均收藏数量”，这样实际上就是单独使用“日均收藏数量”。

为什么不建议单独使用“日均收藏数量”？因为**日均收藏数量对发布时间比较长的作品不公平**。

作品的收藏数量增长是一个曲线。一般来说作品刚发布之后的一段时间内每日收藏数量增长较快；发布一段时间之后，每日收藏数量会降低。

设想如下情况：

- 作品 A 发布 1 天，收藏数量为 30。日均 30。
- 作品 B 发布 5 年，收藏数量 50000。日均 27。

在比较日均收藏数量时，高质量的作品 B 低于普通质量的作品 A。所以这是不合适的。

除非你清除自己要做什么，否则不要单独使用“日均收藏数量”。

-------------

### 可以过滤用户屏蔽的内容了

Pixiv 允许用户屏蔽其他用户，或者屏蔽一些 tag。

现在下载器可以过滤用户屏蔽的内容了。被屏蔽的内容不会被下载。

这个功能是自动的，无需开启。

-------------

### 支持下载好P友页面和粉丝页面

现在可以下载好P友页面和粉丝页面了。

它们和关注页面类似，所以我把关注页面的功能扩展了一下，支持了这两个页面类型。

-------------

### 下载用户列表

在关注页面、好P友页面、粉丝页面里，增加了一个抓取按钮：“下载用户列表”。

这会抓取当前页面类型里的用户列表，并且保存到一个 CSV 文件里。（抓取数量取决于你设置的页数）。

使用这个模式，不会抓取作品详情。抓取完用户列表就会停止运行。

-------------

### 其他优化

- 代码优化；
- 修复 bug；
- 抽离出生成 csv 文件的类；

#### 去除 tag 里重复的内容

https://www.pixiv.net/artworks/86306806

例如这个作品，有 `オリジナル` 和 `創作` tag，它们翻译成中文都是 `原创`。

如果命名标记里使用了翻译后的 tag，就会导致出现两个 `原创`。现在对此进行了优化，去除重复内容，只保留一个 `原创`。

#### 图片抓取结果里的 novelMeta 设为 null

novelMeta 保存着生成小说文件所需要的数据，在小说的抓取结果里是必须的，但是在图片结果里不是必须的。

以前在图片结果里依然会有 novelMeta 的内部数据结构，只是全部为空字符串：

```json
"novelMeta": {
  "id": "",
  "title": "",
  "content": "",
  "description": "",
  "coverUrl": "",
  "createDate": "",
  "userName": "",
  "meta": ""
}
```

现在图片结果里将其设为 `null`：

```json
"novelMeta": null
```

这样在查看导出的抓取结果时，会更易读，而且也减小了体积。每个图片结果将会因此节约 `169 B` 的空间。

## 8.3.2 2020-12-08

### 优化对跳过的下载的处理

#### 优化下载后收藏

之前版本开启“下载后收藏”功能时，被跳过的下载也会进行收藏。

现在被跳过的下载会根据跳过的原因进行区分。因为重复下载而跳过的下载会被收藏。其他原因被跳过的下载不会被收藏。

#### 修复 bug：跳过的下载被保存到记录里的 bug

被跳过的下载不应该保存到下载记录里。

在设计上是这样的，但之前因为事件的执行顺序不符合预期，导致被跳过的下载也保存到下载记录里了。现在修复。

#### 代码优化：跳过的下载不会触发 downloadSuccess 事件

以前被跳过的下载会触发两个事件：EVT.list.skipDownload 和 EVT.list.downloadSuccess。

现在被跳过的下载只会触发 EVT.list.skipDownload。

之前那样其实是有偷懒的因素的，因为跳过下载是后面才加入的功能，所以为了省事，它最后也会触发 downloadSuccess。

这导致事件的区分就变得麻烦。之前如果某个模块监听 EVT.list.downloadSuccess 事件，同时它不希望监听到跳过的下载，就会比较麻烦。所以现在把两个事件区分开了。

## 8.3.0 2020-12-07

>推荐更新级别：一般。如果更新内容对你有用，你可以进行更新。否则无需更新。

### 优化快速收藏功能

上个版本只显示快速收藏的五角星，没法显示心形按钮了。虽然有设计上的因素，不过对一些用户造成了困惑。

这个版本里心形按钮和五角星都会显示~ 区别只在于五角星默认是带 tag 收藏，心形不带 tag 收藏。

两个收藏按钮有联动效果，点击一个收藏，另一个按钮也会变红。

### 优化抓取结果里的小说数据结构

pixiv 并没有给小说作品提供一个 url 来下载这个小说，所以下载器会把要下载的内容生成一个 blob 对象再下载。

以前这个 blob 对象是抓取小说时生成的，储存在 result 里。

现在 result 里不会保存 blob 对象，只会保存相关数据，下载时再生成 blob 对象。

这个改动会带来很多好处：

1. 逻辑更清晰。生成 blob 对象然后下载，这个逻辑放在下载模块里更合适。之前放在抓取模块里不太合适。
2. 动态适应选项变化。在抓取时用户可能设置小说的保存格式为 txt，下载时改成了 epub。在下载时生成 blob 对象可以响应用户对这个设置的修改。之前抓取时生成 blob 对象，下载时不会再响应这个选项的变化。
3. 导出的数据更通用。之前导出抓取结果时，由于 blob 对象无法导出，所以导出之后是空对象。这样导出的数据再导入进来就有问题，因为缺少 blob 对象，而且之前的 result 没有保存用于生成 blob 对象的元数据，所以无法生成小说的 blob 对象，除非再重新抓取一次。现在修改之后会导出元数据，可以直接查看小说内容，而且导入进来可以直接使用。
4. 当保存格式为 epub 时可以加快小说的抓取速度。因为 epub 获取小说的封面图需要时间，抓取时不生成文件也就不会获取封面，使抓取所需的时间缩短了。
5. 减小储存在 indexeddb 里的数据的体积。主要是 epub 有封面图，生成的 blob 文件会比较大，占用的数据库空间比较大。现在只保存小说元数据，不会把封面图保存到数据库里，所以对于 epub 格式来说，极大的减少了占用的数据库空间。
6. 导出 url 时不会导出小说的 blob url。之前会导出小说的 blob url，但是这种 url 其他下载器是下载不了的，只能在浏览器里使用。所以导出也没有意义。现在修改后 result 里小说的 url 是空的，也就不会导出了。这可以避免 blob url 导致的一些困扰。

这个修改对用户来说一般体会不到，除了导出 url 时会发现没有小说的 url。

### 其他优化

删除了抓取 [漫画系列页面](https://www.pixiv.net/user/3698796/series/61267) 时兼容旧版的代码。现在所有用户应该都已经是新版了。

当遇到不支持的页面时，以前会抛出一个错误，现在改为不报错。

## 8.2.0 2020-11-16

>推荐更新级别：一般。如果更新内容对你有用，你可以进行更新。否则无需更新。

### 新增设置项：必须含有的 tag 可以设置全部或者任一

以前如果在“必须含有的 tag”设置了多个 tag，下载器会要求作品必须含有设置的**全部** tag。

现在用户可以设置作品只要含有多个 tag 中的**任意一个**就允许下载。

打开“必须含有的 tag”设置项就可以看到这个设置，默认是全部。

举个例子，`东方 Project` 的作品有时候标签不一致，常见的可能有以下三种：

```東方Project,東方,東方プロジェクト```

有的作品可能只有其中一个标签，所以只搜索一个 tag 是不完整的。现在你可以把这三个 tag 全部填入，然后设置模式为“任一”，这样就不容易漏掉`东方 Project` 的作品了。

### 新增设置项：用户阻止名单

其实就是用户屏蔽名单。开启这个选项，然后输入要屏蔽的用户的 id，这样就不会下载这些用户的作品。

**注意：**

1. 需要输入**用户 ID**，而不是输入用户名。因为用户名不唯一。
2. 如果要屏蔽多个用户，可以输入多个用户 id，中间使用英文逗号 `,` 分割。

### 新增设置项：下载之后收藏作品

可以在设置中开启这个选项。启用后，每当下载完成一个文件，就会自动收藏这个作品。

收藏的进度会显示在下载进度区域。格式如： `已收藏 99/100`

当下载完成之后，看到这里收藏数量是前后相同的如 `已收藏 100/100` 就说明收藏完了。如果不相同就等待一下。

**注意：** 

1. 被跳过下载的文件也视为下载成功，所以也会进行收藏。
2. 一个作品可能有多个文件，但只会进行一次收藏。所以如果你收藏数量比文件数量少，这是正常的。

### 新增设置项：可以设置下载器收藏作品时的选项

新增了一个设置。当下载器把作品添加到收藏时，可以设置：

1. 是否附带 tag
2. 是否为公开收藏

这会影响很多通过下载器添加收藏的操作（pixiv 本身的收藏按钮不受影响）。

**受此设置影响的地方：**

- 作品页面里的快速收藏（☆）按钮
- 搜索页面的快速收藏（☆）按钮
- 收藏本页面所有作品的按钮
- 下载后收藏作品的功能

**不受此设置影响的地方：**

在收藏页面里的“给未分类作品添加 tag”按钮不受影响。因为这个功能必定会附带 tag。并且会根据这个作品之前的收藏状态，自动设置公开或者不公开。

### 删除设置项：启用快速收藏

启用快速收藏 这个设置在之前比较混乱，一方面它控制作品页面内的快速收藏（☆）按钮是否显示；另一方面它又控制一些收藏行为是否附带 tag。现在可以设置下载器收藏作品时的行为了，所以把这个按钮去掉了。

**影响：**

作品页面内的快速收藏（☆）按钮将会一直显示，无法关闭。但是这影响不大，因为如果你不想使用快速收藏功能，你可以把它的行为设置的和 pixiv 原本的收藏按钮一致。

设置不附带 tag，并且公开收藏，这样它的效果就和 pixiv 原本的收藏按钮一致。

### 新增设置项：颜色主题

下载器的主题有白色（默认）和黑色。之前下载器会自动检测 pixiv 的主题是白色还是黑色，自动改变下载器主题。

现在增加了这个选项，可以单独设置下载器的主题，可以不同于 pixiv 的主题。 

现在并没有增加新的主题。

### 新增设置项：管理设置

在“其他”选项卡里增加了“管理设置。你可以直接点击对应的文字进行操作：

1. 导出设置（导出一个 json 文件）
2. 导入设置（选择你之前导出的 json 文件，进行恢复）
3. 重置设置

### 命名规则列表将会保存到选项里

之前命名规则列表不是保存在选项里，而是单独保存的。我觉得命名规则列表的导入导出还是有必要的，所以现在放到了选项里。

导出设置可以导出命名规则列表。导入设置、重置设置也同样会影响命名规则列表。

**警告：**

**升级到此版本后，之前保存的命名规则列表会无法读取。** 你需要重新生成你的命名规则列表。

### 不下载重复文件的默认策略从严格改为宽松

严格模式同时判断 id 和文件名。宽松模式只判断 id。

原本默认是严格模式，但是很多人不理解，两次文件名不一样，下载器没有认为是重复文件。他们就来问我怎么回事，这怎么不算重复啊？我只好和他们解释说你这种想法应该用宽松模式。这样的人多了之后，我就把默认值改为宽松了，少些麻烦。

### 调整了部分选项的位置

把“下载”标签页里的不常用选项移动到了“其他”里面。

### 代码优化

#### 拆分 Settings 类

之前的 `Settings` 类有两方面的主要功能：

1. 管理下载器的设置 `settings`
2. 管理 `Form` 类的 form 表单的设置

这导致了很多严重的问题：

1. 很多时候其他的类只想使用下载器的设置 `settings`，然而引入 `Settings` 类的话，`Settings` 类依赖于 `Form` 类，这经常导致循环引用。
2. 由于两者耦合紧密，导致下载器的设置 `settings` 里只能存放 `form` 表单里的的 `input` 元素的设置，其他类型的设置如“命名规则列表”很难放进去，所以之前“命名规则列表”是单独存储到 localStorage 的。这导致设置难以集中管理，分散凌乱。

现在把 `Settings` 类拆分成了两部分：

1. 管理下载器设置的部分放在 `Settings` 类里
2. 管理form 表单的部分放在 `FormSettings` 类里

这解决了循环引用的问题，而且可以把其他选项都放入 `settings` 里了，用起来舒服多了。

### 修复 bug

#### 修复了点击选项的 label 会触发两次 settingChange 的问题

之前存在一个 bug，点击复选框、单选框的 label 会触发两次 settingChange。这是因为之前在点击 label 时会触发 settingChange 事件，这是第一次。而 label 会触发控件的 click 事件，下载器监听 click 事件时也会触发 settingChange 事件，这是第二次。

去掉对 label 的点击事件的监听就解决了。

### 移除 tabs 权限

Chrome 商店审核时说 `"tabs"` 权限是不必要的，我试了试去掉确实不影响，就去掉了。

### 适配小说搜索页面新增的语言标签

小说搜索页面的筛选条件里最近多了一个语言选项。如下：

https://www.pixiv.net/tags/%E7%99%BE%E5%90%88/novels?work_lang=zh-cn

同时小说页面里获取到的数据也多了 language 属性。但是其他页面里获取的小说数据没有这个属性。

之前的版本里，下载器获取搜索页面的数据时，不会处理语言选项。现在适配之。

## 8.1.1 2020-10-28

>推荐更新级别：一般。如果更新内容对你有用，你可以进行更新。否则无需更新。

### 替换了 wiki 网址

[Wiki](https://xuejianxianzun.github.io/PBDWiki)

使用 docsify 制作了新的 wiki，所以把之前的 wiki 网址换成了新的网址。

新的 wiki 有便于查看的目录，也便于以后翻译成其他语言。

## 8.1.0 2020-10-26

>推荐更新级别：一般。如果更新内容对你有用，你可以进行更新。否则无需更新。

### 可以选择下载器使用的语言

在“其他”选项卡里，增加了 Language 的设置。

一般保持默认的自动检测就可以，下载器会使用和 Pixiv 页面一致的语言。

除非你想让两者不同，比如 Pixiv 使用日语，下载器使用中文，这时才需要修改。

ps：以前偶尔有用户说起过想要单独设置下载器的语言，但是这个需求其实很少。我也嫌麻烦，没有做。现在比较闲所以做了。

为什么说之前嫌麻烦呢，因为我之前预想的是可以无刷新切换语言：修改语言之后会立即生效，不需要刷新页面，也不会影响下载器的工作状态。但是这样实现起来就会很麻烦。今天虽然做了语言切换，但也要刷新才生效，算是个偷懒的办法。（Pixiv 修改语言就是强制刷新页面的，所以四舍五入我就和 Pixiv 程序员一样厉害，逃）

### 其他修改

#### 调整了几个选项的顺序

#### 两个 a 标签改成 button

有俩 a 标签单纯当按钮用的，没有链接，`href="javascript:void()"`。现在改成了 button。

## 8.0.1 2020-10-22

### 保存 {task_date} 数据用于恢复下载

在之前的版本，恢复任务之后的 {task_date} 的时间是恢复任务的时间，而不是抓取完成的时间。

现在下载器会把 {task_date} 保存到数据库，这样恢复任务之后的 {task_date} 仍然是抓取完成的时间。

### 修复 bug

#### 修复了重置设置后，修改选项无效的问题

今天发现了这个 bug，比如命名规则是 `{id}-{tags}`，重置设置，之后修改命名规则，但是不管怎么修改，下载时的命名规则还是旧的 `{id}-{tags}`。刷新页面可以解决。现在对这个bug进行了修复。


原因是因为页面初始化时，其他组件引用了 `settings` 对象。重置设置时，用等号 `=` 重新设置了 `settings` 的值，导致 `settings` 的内存地址变化了，然而其他组件里依然是一开始的旧 `settings`，所以修改选项无效。 

此问题可简化为以下模型：

```
// 导出对象 a
let a = {
  name: 'a'
}
// 模块 b 引用 a
let b = a
// 通过等号赋值改变 a
a = {
  name: 'ccc'
}
// 模块 b 里还是原来的 a，没有变
console.log(b.name)
// 'a'
// 这是因为通过等号重新给 a 赋值，a 的内存地址变成了新的。但是 b 仍然是原来的 a 的内存地址，所以 b 不会变。
```

解决办法有两个：

1. 不改变 `settings` 的内存地址就不会出问题，所以不要用等号赋值。可以用 `Object.assign(settings, newObj)` 代替用等号赋值。
2.  `settings` 是类 `Settings` 的属性。如果在其他类里面使用 `Settings.settings` 来访问，由于类 `Settings` 不会变，所以 `settings` 可以随意改变，不会出问题。但这样写起来麻烦。

使用了方法 1，修改起来很简单。

#### 修复了检查重复文件时，代码没能及时返回的问题

如果关闭“不下载重复文件”，那么下载器应该直接返回“通过”的结果，不应该去读取数据库进行数据对比。但是之前不管怎样都会进行对比。这不会影响下载，但是会浪费额外的资源。

原因是 Promise 函数里有多个 `resolve` 时，没加 `return` 的问题。现在进行了修复。

把情况简化一下，假设有个函数，有 3 个参数作为判断条件，如果检查到某个参数为 false 就直接 resolve，不执行后续代码。那么下面的代码是错误的：

```
async function t(a, b, c) {
  return new Promise((resolve) => {
    if (!a) {
      console.log(a)
      resolve(false)
    }
    if (!b) {
      console.log(b)
      resolve(false)
    }
    if (!c) {
      console.log(c)
      resolve(false)
    }
  })
}

// 执行测试
t(false, false, false)
```

执行上面的代码，会发现里面 3 个判断里的 `resolve` 全都执行了。

以前我对 Promise 存在认知错误，以为 `resolve` 或者 `reject` 一次之后代码就不会执行了，这是错误的。 `resolve` 或者 `reject` 只是确定了 Promise 的状态，后面的代码还是会执行的。所以这种情况需要加 `return` 。

### 优化代码

#### 修复了检查重复文件时，可能出现数据库 add 错误的问题

之前 `Deduplication` 类向 IndexedDB 添加下载记录时，如果这个记录已存在，就会 add 出错，产生一个错误信息。这是一个设计，而且不影响下载。

原因是之前添加记录时，没有先查询记录是否已经存在，直接尝试 add，如果 add 出错说明记录存在，那就改成用 put 来添加。这样虽然会出现一个报错信息，但因为不用先查询记录，所以比较快。

现在进行了修复，先查询记录，根据结果选择使用 add 还是 put。这样不会出现错误信息，但是对于没有记录的数据，因为要先查询一次，所以添加速度会比之前慢。

#### IndexedDB 类里添加了堆栈跟踪的调试信息

在出错的地方添加了 `console.trace()` 来显示堆栈跟踪，以便确定调用链。

### 其他优化

## 8.0.0 2020-10-21

### 新增命名标记 {task_date}

`{task_date}` 记录了这次任务抓取完成时的时间。例如：2020-10-21。

这可以用在文件夹名字里，记录是什么时候进行的下载。

### 可以设置日期和时间格式

有些用户想修改 `{date}` 命名标记的结果，比如从默认的 `YYYY-MM-DD` 改成 `YYMMDD`。

所以我在“其他”选项卡里添加了一个选项，用户可以输入想要的日期格式。这会影响命名规则里的 {date} 和 {task_date} 生成的结果。在这个选项右侧点击“提示”按钮可以看到详细说明。

例如：

- 美国的日期格式可以设置成 `DD MMMM, YYYY`，输出 `21 October, 2020`
- 中国的日期格式可以设置成 `YYYY年MM月DD日`，输出 `2020年10月21日`

以前不能输出时间，现在也可以输出时间了，如设置成 `YYYY年MM月DD日hh时mm分ss秒`。

### 增加了消息显示框

原本用弹窗显示的一些信息，现在会通过一个单独的消息框显示。

浏览器的弹窗会导致页面无法操作，自定义的消息框则没有问题。而且这也可以指定消息文本的颜色。

### 夜间模式的背景色加深

在 Pixiv 的夜间模式里，下载器背景色由原来的 #333 加深到了 #222 ，看起来会更黑了。

### 修复了有时候没适应夜间模式的问题

如果 Pixiv 是夜间模式，以前下载器偶尔会没能检测到，下载面板依旧是白色的。现在进行了修复。

问题在于要先获取一个元素，应该用定时器一直执行，直到找到这个元素为之。之前的代码是 setTimeout ，只检测了一次。现在修复。

### 代码优化

#### 增加了解析日期的类

新增了解析日期格式的类 `DateFormat.ts`。便于用户自定义日期格式，得到想要的结果。

## 7.9.1 2020-10-19

### 修复一些页面抓取失败的问题

p 站最近 api 结果变化，导致一些页面抓取出错，现在修复。

- 抓取搜索页面
- 抓取相关作品
- 抓取漫画系列

发生变化的地方是插画、漫画通用数据（`src\ts\modules\CrawlResult.d.ts` 里的 `ArtworkCommonData`），现在里面没有 `illustId` 和 `illustTitle` 属性了。

### 新版收藏页面里去掉了一键添加 tag 的按钮

因为“一键添加 tag”这个功能需要获取非公开收藏的作品，但现在新版收藏页面里只会显示公开收藏的，不允许获取非公开收藏的，导致这个功能无法使用，所以去掉了这个按钮。

在旧版收藏页面里可以正常使用“一键添加 tag”。

### 功能优化

#### 抓取相关作品的优化

相关作品最多有 180 个。以前如果用户设置只下载一部分（如 10 个），那么下载的文件可能和页面上显示的顺序不同。现在变得相同了。

#### 修复了重置设置时，token 未能自动更新的问题

### 代码优化

#### 拆分了一些类

- 拆分 Support 类；
- 拆分预览文件名的代码为单独的类；
- 拆分复制 url 的代码为单独的类；

#### 优化了一些类型声明

- 消除了一些重复的声明
- 根据 pixiv 的变化进行了相应的修改

## 7.9.0 2020-10-16

### 可以导出/导入去重数据

在“不下载重复文件”选项里，可以导出/导入下载记录。

例如重装浏览器、重装操作系统等情况，可以先导出数据，以后再导入。

### 搜索页的过滤器优化

如果在搜索页设置了时间范围选项，现在可以获得更快的搜索速度。

这是因为以前搜索页的 api 数据里没有时间数据，现在有了，所以可以尽早的过滤时间范围选项。

## 7.8.2  2020-10-15

### 适应搜索页 api 的变化

pixiv 的搜索 api 的结果有一点变化，导致搜索页面抓取出错，现在修复。

## 7.8.1  2020-10-12

### 添加了输出 lst 文件的功能

应一位赞助者的需要，添加了输出 lst 文件的功能。

## 7.8.0  2020-10-12

### 可以设置下载的图片尺寸

在“下载”选项卡里新增了"图片尺寸"的设置，你可以选择要下载的图片尺寸。

[选择下载的图片尺寸-调查](./static\docs\选择下载的图片尺寸-调查.md)

## 7.7.0  2020-10-08

### 功能优化

#### 在画师页面里可以批量收藏作品

在画师页面里也可以使用“收藏本页面的所有作品"功能了。

只会收藏当前页面的作品。如果想收藏多页，需要一页一页执行。

考虑到有些画师早期作品不如现在的好，所以批量收藏不会直接收藏画师的所有作品，而是一次收藏一页。这样便于用户控制收藏的范围。

#### 可以导出抓取结果数据

在“下载”选项卡里，新增了一个按钮：导出抓取结果。

点击它可以把抓取结果导出为 json 文件。

#### csv 里增加保存文件名和原图 url

导出 csv 时，会导出生成的文件名，以及原图的 url（original）。

这有助于用户提取这两项数据，使用其他下载软件下载。

**注意：**

小说的原图 url 是 blob url，所以无法用其他下载器进行下载。

#### 同时下载数量最大值增加到 10

以前同时下载数量最大值是 5，现在增加到 10。

但是默认值仍然是 5，除非用户手动修改到更大的值。这是因为国内一些用户的下载速度比较慢，所以不应该同时下载很多文件。

ps：以前有个说法，Chrome 对同一个 host 最多只能同时发出 6 个并发请求。我现在测试了下，pixiv 的图片请求是 http/1.1，但是可以同时进行 10 个并发请求。不清楚为什么，反正是好事。

#### 保存命名规则的数量上限提高到 20

之前最多只允许保存 10 个，现在提高到 20 个。

### 体验优化

#### tab 栏将会始终显示

tab 栏指的是“抓取、下载、其他”三个控制区块的部分，它们让用户可以切换显示三个对应的区域。

以前当下载面板出现滚动条时，如果滚动到底部，tab 栏就不显示了（被顶部标题遮挡了）。这样不方便，因为用户无法直接切换到其他选项卡了，必须先滚动回顶部，然后再切换。

现在进行了优化，即使滚动到底部，tab 栏也仍然会一直显示。这样便于用户切换显示区域。

技术上是使用 css 的 sticky 定位，这个效果很容易的被实现了。如果没有 sticky 定位，将现有布局修改成这样会很麻烦。

**注意：** 部分安卓系统上的浏览器对 sticky 定位的支持或许不好。不知道安卓上的 Yandex 浏览器是否能良好的支持——考虑到它使用 chromium 内核，所以我觉得应该是支持的。但是要等新版本发布到商店，才能在 Yandex 上进行测试。

#### 点击页面其他区域可以关闭下载面板

多了一种关闭下载面板的方法。点击下载面板以外的区域，就可以关闭下载面板。

以前可能大部分用户是点击下载面板右上角的关闭按钮（x）来关闭下载面板的。但是长时间的使用中，总是使用鼠标点击这个按钮，可能会觉得麻烦，或者觉得累。现在新增的这个方式更加方便：只要点击下载面板以外的区域，就可以关闭下载面板。

### 代码优化

#### 优化点赞

在 API 类里添加了点赞的 API。

快速收藏时会自动点赞，之前是模拟点击网页上的“like”按钮，现在则通过 API 发送点赞请求，更加可靠。

#### 优化 token 类

之前其他类获取 token，使用 `token.getToken()` 方法，现在改为使用属性 `token.token`，使用起来更方便，也避免了重复的计算。

#### 优化 BookmarkAllWorks 类

原本它自己创建绿色按钮，现在改为构建时由外部传入。

对内部数据结构做了优化。

### 其他

#### 修改群号

之前的 qq 群满了，现在修改为新的群号。

## 7.6.0  2020-09-23

### 可以保存页数设置/个数设置了

不同页面的页数设置/个数设置的默认值和范围都是不同的。所以以前没有保存这个设置，现在进行了保存。

使用数组保存所有页面类型里的页数/个数设置。

调整了其他组件里与此相关的部分代码。

### 代码优化

#### 独立出了获取 token 的类

之前这部分代码主要在 API 里，但是因为 API 是静态类，所以事件监听放在了 Support 类里。现在将其独立出来。

#### 优化 一键收藏所有作品 的代码

优化了代码逻辑。并且如果以后其他页面要使用这个功能，也会更加方便。

#### 优化过滤器的一些代码

### 修复 bug

以前重置设置的功能存在一些 bug: 因为 settings 直接引用了默认设置，导致默认设置被改写，导致实际上并不能重置 localstorage 里的设置。现在修复。

## 7.5.0  2020-09-18

### 宽高设置可以设置大于、小于、等于

提供了以下选项：

- 大于等于
- 等于
- 小于等于

### 体验优化

#### 下载进度条上的文件体积可以显示 MiB

以前文件体积都是显示的 KiB，现在添加了 MiB 作为单位。

1. 如果这个文件的体积大于 1 MiB，就会以 MiB 作为单位显示。小数点后保留一位小数。
2. 文件开始下载之前，默认显示的大小 `0 KiB` 改为 `0 MiB`。

**tip:**

今天调查了两个排行榜上文件的体积。

- 文件平均体积接近 2M
- 1M 以下和 1M 以上的大约分别占一半

#### 加强对彩色、黑白的检查

在下载阶段对图片进行黑白检查，之前在这里不检查第一张图，现在第一张图也会被检查，更加准确。

#### 提示文本优化

命名规则点击问号之后会展开提示。提示底部的文字现在移动到了顶部：

```
一定要包含 {id} 或者 {id_num}{p_num}。
您可以使用多个标记；建议在不同标记之间添加分割用的字符。示例：{id}-{userid}
* 在某些情况下，会有一些标记不可用。
```

这是为了让更多人看到这些提示。主要是不加 `{id}` 或者 `{id_num}{p_num}` 导致重名的人有点多。

#### 搜索页面：第一次筛选之后会显示下载面板

之前第一次筛选之后不显示下载面板，这样用户之后打开下载面板可以看到筛选按钮，便于进行二次筛选。

但是有时候不需要二次筛选，只需要下载，所以还是显示下载面板更方便一些，也减少了用户的困惑。

#### 搜索页面：修改多图作品设置之后，会立即应用更改

假设第一次筛选时没有开启“多图作品设置”，筛选之后开启了这个设置。这个设置会影响要下载的文件数量。

之前当用户修改这个设置之后，需要手动点击“在结果中筛选”按钮，才会重新计算结果。现在改成自动的了，修改设置之后会立即应用结果，不需要点击其他按钮。

### 代码优化

#### 建立了 setting 文件夹存放设置相关文件

统一存放设置表单相关的类的文件。

#### 从 form 读取设置的地方改为从 settings 读取设置

之前因为历史遗留原因，当其他组件要读取表单上的设置时，从 form 读取，如：

```
form.userSetName.value
form.downColorImg.checked
```

form 是设置表单的 view 层， `Settings` 类的成员 settings 是 model 层。所以可以直接从 settings 读取数据，如：

```
settings.userSetName
settings.downColorImg
```

修改以后看起来更加简洁，并且有类型提示。以前 form 的属性是 input 元素，无法获得类型提示。

#### SettingAPI 和表单 Form 拆分成两个类

之前是在一个类里的，道出了两个对象。这主要是历史遗留原因，并没有要放一起的理由。现在拆分成两个类了。

#### 保存了设置面板的所有设置项

之前 `Settings` 类里没有保存所有设置项，现在改为保存所有设置项了。

注意：页数/个数设置是特例，虽然会保存到 settings，但是不会从 settings 里恢复。

#### 优化 Filter 类

- 自动响应设置变化。在抓取途中修改过滤器使用的设置，过滤器可以立即应用。以前需要重新开始抓取才能应用。
- 缓存一些值，避免重复计算，提高效率，减少资源占用。
- 增加了一个标记，可以指示过滤器获取设置的值时，是否输出日志。
- 改变：将动图视为单图。之前动图不参与单图、多图判断，现在改为视为单图。

#### 优化“首次登场”的状态管理

排行榜页面的“只下载首次登场作品”按钮的状态，之前是在 form 里添加了一个隐藏的 input，储存它的值。现在改为使用 `States` 类里的 `debut` 属性。

#### 优化 crawlFinish 事件

以前，当抓取完成时，如果结果为空，会触发 `crawlEmpty` 事件；如果有结果，则触发 `crawlFinish` 事件。

但是这样是不合理的：抓取完成时只会触发两者之一，这使得监听变得难以处理，有时候不得不同时监听这两个事件。

现在进行了修改：不管结果是否为空，都会触发 `crawlFinish` 事件，只监听这个事件就可以了。如果结果为空，则会额外触发 `crawlEmpty` 事件，可以根据需要决定是否监听这个事件。

#### 优化搜索页的事件、状态、代码

之前二次筛选之后触发的是 `crawlFinish` 事件，现在改为一个单独的 `resultChange` 事件。

这样使事件系统减少了一些复杂度，现在 `crawlFinish` 事件只有一个触发者了。而且其他组件也可以分辨这两个事件。

在此基础上，优化了代码和一些状态，消除了搜索页里的三个状态标记。

优化了代码逻辑，减少理解难度。

#### 删除了 `PageInfo` 类

`PageInfo` 类获取页面的 tag 和 title，并在开始抓取时保存到 `store` 里。这导致这两个类里都有 tag 和 tiele，引用时需要分辨它们含义的不同，并且显得重复。

现在优化了获取 tag 和 title 的 API，直接在 `store` 里保存，删除了 `PageInfo` 类。

#### 优化 checkWantPageInputGreater0

`checkWantPageInputGreater0` 当页数/个数设置要求大于 0 的时候使用这个方法。现在对它进行了优化，可以直接返回值，并且输出日志提示。

#### -num- 占位符替换成 {}

下载器的界面文本使用 `{}` 作为占位符，如 `下载排行榜前 {} 个作品`。

以前因为历史遗留原因，有些地方用 `-num-` 做占位符，现在替换成 `{}`。

#### 优化了页面初始化时的一些代码

#### 按键事件的 keyCode 替换成 code

keyCode 已被弃用，现在替换成 code。

#### 整理了 EVT 类

对每个事件添加了注释

修改了一些事件的名字

删除了一些没有被使用的事件

#### 其他优化

### 修复 bug

#### 修复快速收藏按钮有时没有出现的问题

第一次进入作品页面不会出现这个问题。之后无刷新切换到其他作品时，则有一定概率发现快速收藏按钮没有出现。现在进行了修复。

原因是 DOM 更新引起的。下载器会查找 pixiv 原本的收藏按钮，找到之后隐藏它，然后添加快速收藏按钮。但是在页面切换时有点麻烦：收藏按钮区域的元素是重新生成的。

当页面切换的动作已经触发之后，下载器会查找新生成的 pixiv 的收藏按钮。但有时候旧的收藏按钮没有消失，下载器找到了旧的收藏按钮，并添加了快速收藏按钮。之后页面元素更新，此时才生成了新的的 pixiv 的收藏按钮，并且因为元素更新，导致快速收藏按钮被清除了。

解决办法是，下载器会给 pixiv 原本的收藏按钮添加一个标记。当页面切换时，下载器会查找这个按钮，如果它有标记就说明它是旧的，不进行处理。直到新的按钮出现（没有这个标记），下载器才添加快速收藏按钮。这样不会出错。

#### 修复搜索页面抓取出错重试时的 bug

搜索页面在抓取列表页时如果出错了，会进行重试，重新抓取出错的这一页。

之前存在 bug，如果某一页出错了，实际上并不是重新抓取它，而是跳过了它然后向后抓取。

例如抓取 1-10 页，第 4 页出错了,由于第 4 页的页码已经使用过了，所以重试时的页码不是第 4 页了，而是向后延续，最后的结果就是抓取了 1-11 页，其中没有第 4 页 的结果。

这个问题只在并发执行 `getIdList` 时才会出现。如果是单线程的执行 `getIdList`，在请求成功之后才增加页码，出错时并没有增加页码。并发执行时因为要同时请求多个页面，所以在请求发出之前就增加了页码，才导致出现了这个问题。目前只有搜索页面（搜索插画、漫画和小说）是并发执行的。

现在进行修复。解决办法是重试时传递要重试的页码，直接使用这个页码，而不是继续增加页码。

## 7.4.0  2020-09-08

### 可以导出抓取结果为 csv 文件

效果如图：

![20200908152809.png](https://i.loli.net/2020/09/08/fQUC3wnNgjdLPep.png)

这个 csv 文件保存了每个作品的一些信息。

一个多图作品在下载时可能产生多个文件，但是 csv 文件里只会保存一份信息。（第一张图的信息）

这个文件不能用于恢复下载。但是你可以复制 `id` 一列的数据，然后到首页使用“输入 id 下载”，这样可以再次下载这些文件。

### 代码优化

#### 独立出了快速下载按钮

以前快速下载按钮内置于 `InitArtworkPage` 类中，现在成为了一个独立的类，并且可以在任意页面使用。（但是目前并没有在其他页面使用的打算）(如果在其他页面使用的话，可以当做“开始抓取”按钮的快捷方式)

#### 独立出了 store 里的状态

之前 store 里保存了 states 对象，现在把这些对象移到了单独的 `States` 类里，便于管理，逻辑也更清晰了。

## 7.3.1  2020-09-07

### 停止下载时，清除断点续传数据

之前如果在下载途中停止了下载，但是刷新页面之后你会发现又继续开始下载了。

这是因为停止下载时，任务尚未完成，所以刷新页面后会进行断点续传，导致又开始下载了。

现在优化了这里，停止下载时会清除这个任务的数据，不会导致断点续传。

## 7.3.0  2020-09-03

### 新增命名标记 tags_transl_only

`tags_transl_only` 只保存翻译后的 tag，不保存原本的日文 tag。

但是如果某个 tag 没有翻译，则会保存原本的 tag。

### 可以设置文件名长度上限

一般不需要开启。除非当你确定是因为文件名太长导致了问题，才需要启用这个设置。

如果文件名太长的话，Chrome 可能会自动截断，不会导致保存失败。

在一些特殊情况下，Chrome 可能不会自动截断文件名，导致保存失败。例如：你把下载位置设置到 NAS 或云端硬盘时。

*文件名长度上限只影响文件名部分（含扩展名），不影响文件夹部分。请注意不要让文件夹名字超长。*

### 适配新版漫画系列页面

最近漫画系列页面改版了，目前一部分人是新版，一部分人是旧版。

现在兼顾这两种情况，进行了适配。

### 保存命名规则的列表适配了夜间模式

之前增加这个功能的时候忘记适配夜间模式，现在适配。

### 修复加载命名规则时，不会保存问题

修复了加载命名规则的时候，不会保存的问题。

当初加这个功能的时候，没注意到这一点，现在补上了。

### 过滤 tag 可以使用翻译后的 tag 了

设置必须包含的 tag 或者必须排除的 tag 时，以前只能使用日文 tag，现在**在部分页面里**可以使用翻译后的 tag 了。

所以还是推荐只使用日文 tag。

**注意:** 一个 tag 在不同语言里可能有不同的翻译，所以使用日文 tag 是最稳妥的。如果你不切换 pixiv 的语言，那么可以只使用翻译后的 tag。如果你切换了 pixiv 的语言，则要注意这一点。

### 打包不再生成 source-map

因为打包后的代码没有做混淆，只是把模块的依赖做了兼容，所以并不需要 source-map。

而且 source-map 会增加编译时间，增加打包文件的体积，去掉了也挺好。

## 7.2.0  2020-09-02

### 动图可以保存为无损的 APNG 格式

如果你选择 APNG 格式，下载器可以把动图保存为**无损**的 APNG 动画。

但是需要注意，APNG 文件的体积在下载器的几种动图格式里是最大的。

### 适应浏览器的变化

从 Chrome 85 开始，扩展程序的前台脚本不允许进行跨域请求了。

这导致下载器无法下载 pixiv 的图片，现在进行修复。

### 代码优化

优化了转换动图的代码。之前是一起放在一个类里的，现在分离出了提取 zip 的类、转换每种格式的类、流程控制类。代码更易读易于理解和修改了，而且对一些代码也进行了优化。

## 7.1.0  2020-08-26

### 可以保存、切换命名规则

在命名规则一栏里，增加了“保存”和“读取”按钮，你可以保存不同的命名规则，并随时切换。

## 7.0.0  2020-08-24

### 界面优化

#### 优化下载进度条的显示

每个文件的进度条里，有文件名和已下载这两部分。之前排列的比较乱，现在进行修改，更整齐了，而且文件名部分可以显示更多文字了。

#### 美化滚动条

下载器的滚动条会变成蓝色的。

美化了以下界面的滚动条：

1. 下载面板
2. 输出面板
3. 日志区域

其他的好像也没什么面板了。

### Alt + Q 启动快速下载

在作品页面里，你可以使用快捷键 `Alt` + `Q` 启动快速下载。

### 代码优化

#### 一些解耦

使用监听事件的方式，将 `TitleBar` 类从其他模块中解耦了。

但 `TitleBar` 里监听了下载流程的事件，其实也不算解耦，只是没以前那样生硬了。

#### EVT 增加 resume 事件

当断点续传加载了未完成的任务时，之前触发的是 `crawlFinish` 事件。但是**恢复下载**并不应该使用**抓取完成**的名字，只是这样可以省点事，进入下载流程。这种做法使得事件系统变复杂了，现在修改。

现在恢复下载时会触发 `resume` 事件，并且添加了对应的事件监听。

#### 连锁触发事件时需要注意的情况

“连锁触发事件”，指的是触发事件 A 之后会导致触发事件 B 这样的连锁情况。

如果下面的模块先执行，它监听了事件 A，执行代码，在后续代码里触发了事件 B。

```
listen(A,()=>{
  func()
})

func(){
  // ... code
  fire(B)
}
```

另一个模块里监听了这两个事件，A 和 B：

```
listen(A,()=>{
  console.log('A')
})

listen(B,()=>{
  console.log('B')
})
```

触发事件 A 进行测试，会看到后面的模块先输出 `B`，后输出 `A`，顺序乱了。

为什么会这样呢？一个猜测是，在代码里通过 `dispatchEvent()` 主动触发的事件，其回调函数是立即执行的（也就是同步的）。

解决办法是在“连锁触发事件”时，将后触发的事件放入异步队列，如：

```
func(){
  // ... code
  settimeOut(()=>{
    fire(B)
  },0)
}
```

#### 其他优化

## 6.9.0  2020-08-18

### 增强了宽高条件、宽高比例的检查

下载器在抓取阶段只能获取到第一张图片的宽高，检查不到后面图片（p1 及之后）的宽高。现在，在下载阶段，当下载了后面的图片时，会对它们进行宽高检查，如果这个图片不符合条件就不保存它。

示例网址：https://www.pixiv.net/artworks/81983126

这个作品第一张图片是横图，后面的都是竖图。以前，如果宽高比例设置为“横图”，那么这里面的图片都会下载。现在可以正确处理，只下载第一张图片。

### 下载区域会提示跳过下载的数量

下载时可能会过滤掉一些文件，跳过下载。此时日志会提示跳过下载这个文件，但之前并没有统计总数。

现在，在下载区域的下载状态旁边，会显示“已跳过 n 个文件”。

目前跳过下载的原因有：

1. 检测到重复下载
2. 体积不符合设置
3. 颜色不符合设置
4. 宽高不符合设置

### 其他优化

- 转换动图时会在下载区域提示“正在转换n个文件”，此功能独立到了一个类里。从该版本开始，这个提示不会出现在日志区域里。

- 网页右侧的下载按钮从 div 元素改成了 button 元素，这样它们可以被 tab 到了。

有个隐藏的问题：右侧按钮都是在 `document.body` 的 `afterbegin` 位置添加的。如果执行 js 来添加多个按钮，后添加的按钮在元素的顺序上反而会排在前面。在作品页面里有两个按钮，快速下载按钮是后添加的，但是它排在第一个。因为快速下载按钮的使用频率很高，所以这正好是我想要的效果。如果要添加更多按钮的话，就要注意顺序问题了。

- 优化了一些 dom 结构
- 优化了一些日志提示
- 其他优化

## 6.8.5  2020-08-17

### 修复 bug

1：修复了搜索页面使用“收藏本页面的所有作品”功能的 bug。因为现在被二次筛选过滤掉的作品会被隐藏，所以批量添加收藏时，需要过滤掉隐藏的作品。之前没有过滤掉隐藏的作品，导致被过滤掉的作品会被添加收藏。现在修复。

2: 修复了搜索页面进行多次“开始筛选”时，一处日志显示错误的问题。之前，后一次抓取完成的提示“当前有 xx 个作品”的数量“xx”是前一次抓取的作品数量，这是因为日志输出的早了。现在修复。

3：修复了在首页“清空已保存的抓取结果”之后，提示文字显示错误的问题。替换成了正确的文本。

## 6.8.4  2020-08-13

### 修复 bug

EVT.fire 取消使用 setTimeout 0。之前的版本把触发事件做了 setTimeout 0 处理，解决了某些问题。但是这样修改之后导致一些之前正常的功能出现了异常。现在进行了修复。

现在想想，本来就不该给触发事件的代码加 setTimeout 的，所以又取消掉了。

有些地方用的 setTimeout 0 是合理的，目的是“这段代码可以延后执行”，如果执行早了可能不符合预期。但是触发事件应该尽快执行，所以不宜加延迟。

### 其他优化

优化了一些日志提示文本

优化了首页抓取 id 列表时一些处理

搜索页面“去除热门作品上面的遮挡”使用定时器循环检测，减小了检测间隔，之前的 500 ms 有点太大了。

### 调查 好P友的最新作品 页面

https://www.pixiv.net/mypixiv_new_illust.php

它和“已关注用户的最新作品”页面是挨着的，但是两者的结构并不相同。它是以前的旧式页面，图片列表是 `class="image-item"`，而“已关注用户的最新作品”是新的页面，内容是框架生成的。

我本来想做这个页面的抓取，但是我的好 p 友太少了，作品只有几个，难以测试翻页等情况。而且也没人提过这个需求，所以先不做。

## 6.8.3  2020-08-11

### 修复 bug

最近发现有个不影响使用的 bug：从作品页无刷新的进入到其他页面时，快速收藏组件仍然被调用（但它只应该在作品页面生效）。然后它去获取作品信息，但是这会失败，导致产生一个错误。

现在修复了这个 bug。

这个 bug 的原因在于作品页里监听了 `EVT.events.pageSwitch` 事件，但是当这个事件触发时，只知道是切换了页面，并不知道页面类型是否发生了改变。可能改变了，也可能没变。快速收藏组件只应该在页面类型没有变化时才能重新调用。

之前关于页面切换有两个事件：

- `EVT.events.pageSwitch` 页面切换
- `EVT.events.pageSwitchedTypeChange` 页面切换并且类型改变

现在增加了一个新的事件，用于解决这个问题。

- `EVT.events.pageSwitchedTypeNotChange` 页面切换并且类型不变

## 6.8.2  2020-08-10

### 修复 bug

修复了上个版本修改导致的 bug：搜索页面抓取时会不停输出日志，显示抓取到的作品数量。

### 其他优化

优化了一些日志文本

优化了图片转 icon 的代码

## 6.8.1  2020-08-04

### 优化筛选搜索结果时的体验

用户可以预览搜索结果，并且可以通过多次筛选或删除作品，来进一步减少搜索的结果。

之前是这样的，抓取完成之后会生成全部的作品列表。如果之后需要删除一些结果，则先清空生成的所有作品列表，然后重新生成保留的结果。这样处理比较简单，但是如果搜索结果很多，每次生成结果都会消耗比较多的时间。近来因为 fire 自定义事件时都设置了 setTimeout 0，导致这个地方出了点问题，用户体验更糟糕了。

现在进行了修改，生成全部的作品列表之后，如果需要删除结果，则查找需要删除的作品直接删除。不会重新生成作品了。这样用户体验改善了很多。不过代码又变得复杂了一些。

### 优化搜索页面 s_mode 参数

有时候搜索页面没有 `s_mode` 参数，如

https://www.pixiv.net/tags/%E5%A4%A9%E4%BD%BF/illustrations?mode=safe&ratio=0.5

此时展示的结果为严格模式（要求 tag 完全一致）的结果。请求 api 时应该将 `s_mode` 参数设置为 `s_tag_full`，而不是留空，因为留空的话服务器会返回宽松模式的数据。

之前这里没有处理，因为宽松模式可以获取更多搜索结果，但是结果不够精确。现在处理了这里，抓取结果会与页面显示保持一致。

### 优化 log 组件

log 区域设置了最大高度，超出最大高度就会出现滚动条。

之前 log 组件每次新增或刷新一条日志时，会立即滚动到底部，但是有时候日志刷新很频繁，频繁的“滚动到底部”会导致页面卡顿。现在使用定时器来定时检查是否需要滚动，减少了滚动的频率。

### CenterPanel 组件通过自定义事件解耦

之前如果其他组件需要打开或关闭中间面板，需要直接操作 CenterPanel 组件。现在通过自定义事件解耦。

### 其他优化

--------

另外今天用 Chrome 的性能分析工具，发现下载器删除搜索结果时，Pixiv 页面上的 `gtm.js` 会进行大量的 DON 操作，消耗的时间比下载器重绘搜索结果还多。

## 6.8.0  2020-07-31

### 可以把用户头像保存为 ico 图标

在用户页面或者作品页面内，点击下载面板的“其他”选项卡，可以看到这个按钮。

点击之后下载器会把用户头像保存为 256*256 像素的 ico 文件。ico 文件可以设置成文件夹图标，这样你就可以把画师文件夹的图标设置成画师的 pixiv 头像了。

批量下载图片时不会自动保存画师头像。

### 可以清除保存的抓取结果

保存的抓取结果用于恢复未完成的任务。

在首页，点击下载面板的“其他”选项卡，可以看到“清空已保存的抓取结果”的按钮。点击可以清理。

在其他页面没有这个按钮。

### 其他优化

## 6.7.0  2020-07-28

### 对 Pixiv 的“夜间模式”进行适配

今天有人说夜间模式下，收藏按钮不显示。[issues/91](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/91)

其实之前我没用过夜间模式，现在对夜间模式进行了适配，下载器的界面也会跟随主题变化了。

### 下载完成后自动重试失败的任务

减小了因为网络问题下载失败时重试的次数，现在为 30 次。

超过重试次数的文件是下载失败的，等到下载完成后，下载器会自动暂停然后再继续下载，重新开始下载这些失败的文件。

### 屏蔽收藏作品后出现的广告

现在点击 p 站的收藏按钮之后，会在作品下方出现广告区域，偶尔甚至会出现两个广告区域。现在通过 css 屏蔽这些广告。

## 6.6.1  2020-07-24

### 默认关闭“不下载重复文件”选项

之前这个选项是默认打开的，但是因为下载气的去重并不是真的检查硬盘上的文件，所以不严谨，应当默认关闭。

如果用户把下载的文件删除或者剪切走了，但下载器保存了下载记录，以后也依然会跳过这些文件的下载。这就会造成一些用户的困扰。所以把这个选项改为默认关闭。

## 6.6.0  2020-07-23

### 添加不下载重复文件的功能

利用 IndexedDB 存储下载记录，实现去重功能。详细说明可以查看 `/static/docs/去重.md` 文件。

安装该版本之后才能储存今后的下载记录，之前版本下载是没有记录的。而且用户也可能会清除数据的时候清除掉记录。

去重功能也造成了其他一些组件的变化，比如快速下载一个文件时，如果这个文件是重复的，那么抓取完毕事件和下载完成事件会在瞬间依次发生。而断点续传在这种情况下出现了问题，因为它数据库操作需要的时间比较长，所以在一些地方加上了判断是否下载完成的代码。

今天还遇到个问题，监听事件时发现监听到的顺序不对，后来用 setTimeout 0 的方法解决了。

### 下载失败的文件不再保存成 txt 文件

之前，下载失败的文件会生成一个 txt 文件下载，并把它标记为已下载。现在进行了修改，下载失败的文件不会生成一个 txt 文件，也不会被标记为已下载。

现在，如果下载途中有下载失败的，那么当所有文件都下载完之后，不会显示“下载完成”，而是自动进入暂停状态。这是因为出错的文件不算已下载。

自动暂停之后，点击开始下载，或者刷新页面（利用断点续传功能），下载器就会再次下载那些失败的文件。

这个修改是为了能让断点续传恢复这些下载失败的文件。之前下载失败的文件也算已下载，那么在所有文件下载完成后，断点续传会清空这个任务的数据，这时自然也清空了下载出错的文件的数据。这样就导致断点续传无法恢复这些出错的任务，现在修改之后则可以恢复了。

## 6.5.9  2020-07-22

这是 6.6.0 的预发布版本。

### 优化搜索页面不启用快速收藏时的处理

收藏页面里，之前即使不启用快速收藏，点五角星添加收藏时还是会附带 tag。

现在改成这种情况下不带 tag 了。

### 其他优化

## 6.5.0  2020-07-16

### 优化断点续传功能

IndexedDB 单次 add 或者 put 的数据不能超过 127 MB，所以如果抓取结果很多，就会导致存储失败。现在进行了优化，解决这个问题。

这个限制搞得还是挺麻烦的，存储、读取、删除都要考虑分批。

---------

当页面切换时，本程序会自动检测这个页面有没有断点续传数据。之前忘记加页面切换的检测了。

---------

断点续传里保存下载状态，之前是下载一个保存一次最新在状态。但是抓取结果太多（几十万）的话，put 一次数据时间长的话可能要 500 ms 左右，所以改为定时存储，每隔几秒存一次。

下载异常的话，可能最近几个下载的文件的状态没有保存上，不过因为数量少，所以问题不大。

---------

保存和恢复数据时，在 log 区域添加提醒文字。

### 作品页内快速收藏时，自动点击原生的收藏按钮

p 站最近的新功能，在作品页面点击收藏之后，作品下方会出现推荐作品。但是本程序开启快速收藏时，隐藏了 p 站原本的按钮，这样就不会显示推荐作品了。现在对这个问题进行了修复。也就是自动点一下原生的收藏按钮。

### 其他优化

优化了快速收藏时获取点赞按钮的操作。也就是多了一种方式来获取，这是为了防止原本的方式失效。

## 6.4.9  2020-07-10

### 加入断点续传功能

一个页面只会保存最后一次抓取。抓取完成后，抓取到的数据会被存储。下载完成后这些数据会被清除。

如果页面打开后，本程序检查到这个网址下有未完成的任务数据，则会自动进行恢复。

这项功能默认开启，并且也无法关闭。

如果数据量太大的话，保存和恢复数据需要一定的时间。

#### 一些技术方面的说明

使用 IndexedDB 存储每个页面抓取任务的数据。细节可以参考 `Resume.ts` 和 `static/doc/断点续传.md`。

断点续传恢复时，需要模拟出正常下载的状态。正常情况下，在可下载之前进行了一些工作，如获取页面信息，初始化过滤器等。恢复下载时没有经过这些过程，所以要直接执行一次这些代码，然后再进入下载状态。不知道这些需要初始化的地方是否还有遗漏的。

在恢复小说的下载时，一个问题是小说的 url 是 blob url，刷新页面之后就失效了。为此只好把小说的文件整个保存在数据库里。下载时如果检测到这是小说下载失败，就用保存的数据重新生成一个 blob url。

似乎没有办法知道数据库文件有多大。我本想限制数据库体积不超过一定大小，但是看来不好做到。所以现在是定时清理超过一定时间的的数据。目前设置的过期时间是 30 天。超过这个时间的数据，应该没有保存的价值了。

### 其他优化

优化了下载控制、过滤器的一些地方。

## 6.4.1  2020-07-06

### 当输出面板内容太多时，保存到一个 txt 文件

目前设置的数字是 5000，当抓取的文件超过这个数量时，预览文件名、复制 url 等操作不会在输出面板显示，而是保存到 txt 文件里下载。

这是因为结果太多时，输出的内容也多，当点击复制时可能会导致页面崩溃。（和电脑配置有关）

### 其他优化

把一些应该可以点击的地方（复制按钮、常见问题按钮）从 div 改成了可以 tab 到的元素。

输出面板可以设置标题了。

## 6.4.0  2020-07-01

### 支持在搜索页面，一键收藏该页面所有作品

在搜索页面打开下载面板，“其他”选项卡里有一个按钮“收藏本页面的所有作品”，点击就会自动抓取当前页面的所有作品，自动收藏，自动添加 tag。

**注意：**
- 图片和小说页面都可以支持；
- 只抓取**当前**页面，不会抓取后续其他页面。
- 收藏时直接收藏所有作品，不会根据抓取条件过滤某些作品。如果要过滤，请先进行筛选，然后再使用这个功能。

此功能由群友“错过”向我赞助，让我添加了这个功能。

### 优化获取 token 的操作

关于 token，有个偶发问题。本程序通过加载 pixiv 的一个网页来获取用户 token，设置是 5 分钟更新一次。

假如用户之前登录的是账号 A，之后登录了账号 B。可能刚切换到账号 B 的几分钟内 token 没有更新，就会导致需要使用 token 的功能出现问题，比如收藏作品的功能。

现在针对这个问题进行了一些优化。当用户重置设置时，下载器会清空保存的 token，然后立即更新一次 token。之后再使用相关功能应该没问题了（如果还有问题，请刷新页面之后再使用相关功能）。

## 6.3.0  2020-07-01

### 完善了 一键下载所有关注用户的作品

之前没有添加抓取出错重试的功能，现在加上了。

如果关注的用户非常多，抓取到的结果也可能非常多，一次性下载恐怕会出问题。建议分批下载。

## 6.2.9  2020-06-29

注意：这是一个预发布版本，新增的功能可能不稳定！

### 一键下载所有关注用户的作品

在自己的**关注页面**可以一键抓取所有关注用户的所有作品；也可以指定页数只抓取一部分用户。

我测试了我关注的用户，共 2650 个用户，有 42W 个作品。这还没有抓取作品详情，如果抓取了的话可能最终图片数量是作品数量的 3 倍左右。

### 增加下载出错的重试次数到 100

当一个作品下载出错时，本程序会自动重试一定次数。之前是 50 次，现在加大一些吧。

### 其他优化

预览文件名时，如果抓取结果的数量很多（目前设置的数字是 5000），则不为预览结果添加不同颜色。只直接输出字符。

这是因为添加颜色会导致生成的 HTML 元素数量增多，复制时资源占用增加。有些用户电脑配置差，如果生成的结果很多，还添加了颜色，可能复制时会导致这个页面卡死。

## 6.2.0  2020-06-29

### 对系列作品，新增了两个标记

**series_title**  系列标题

**series_order**  这个作品在系列中的序号

下图的下载结果，用 series_title 建立文件夹，在其中用 series_order 保存了作品的编号。

![2020-06-29_100743.png](https://i.loli.net/2020/06/29/SPtcH1vrURohQTb.png)

------

测试用例：

小说系列如： https://www.pixiv.net/novel/series/1035507

漫画系列如： https://www.pixiv.net/user/34367290/series/52042

### 支持了漫画的系列作品页面

漫画系列如： https://www.pixiv.net/user/3698796/series/61267

不知道插画类型的作品有没有系列页面

### 修改命名标记 userid 为 user_id

userid 直接把俩单词连起来而且也没区分大小写就有点不规范，现在修改成了 user_id。

不过在命名标记里 userid 依然可以使用，否则用户升级到新版本就歇菜了。

### 其他优化

在 manifest 里添加了本扩展 github 页面的链接，右键扩展图标时，点击扩展程序名称，可以跳转到 github 页面。

## 6.1.3  2020-06-03

### 上架到了 Edge 商店

[https://microsoftedge.microsoft.com/addons/detail/hpcoocgpiepjcngmhhknkflhpkoklphp](https://microsoftedge.microsoft.com/addons/detail/hpcoocgpiepjcngmhhknkflhpkoklphp)

版本比谷歌商店更新，因为谷歌商店最近没有上传新版本。

### 其他优化

修正了在搜索页面首页如 [FGO](https://www.pixiv.net/tags/FGO)，预览结果显示的位置不对的问题。

### 添加 Privacy Policy

因为 Edge 需要 Privacy Policy，所以自己编写了一个，看起来还行。

## 6.1.2  2020-05-28

### 更新界面中的繁体中文

 [VHlqg](https://github.com/VHlqg) 对本程序中的繁体文字进行了完善，并且提交了繁体版的 README。因此重新打包进行更新。

## 6.1.1  2020-05-12

### 完善小说下载

新版收藏页面的小说分类里，当带有 tag 的时候，之前不能正确抓取，现在发现了这个问题，进行适配。

### 优化检查新版本的代码

### 编译 less 时不再压缩 css 文件

之前 `npm run less` 命令里， `lessc` 加了 `-x` 压缩参数，把生成的 css 文件进行压缩。但是打包时， `fmt` 命令又会把 css 展开，所以这个压缩没有必要，现在去掉。

## 6.1.0  2020-05-11

### 替换小说里的标记

根据 [issues 78](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/78)，对一些标记进行了处理。

下面是一些测试时用的数据：

https://www.pixiv.net/novel/show.php?id=12336777 包含
```
[newpage]
[[jumpuri:こちら >https://twitter.com/kyoka_izumi1]]
```

https://www.pixiv.net/novel/show.php?id=12883824 包含
```
[[rb:莉莉丝 > Lilith]]
```

https://www.pixiv.net/novel/show.php?id=10083001 包含
```
[pixivimage:70551567]
```

### 其他优化

小说保存为 txt 时，去掉里面的 html 标签。

小说没有 tag 的 tagsTranslated 数据，使用 tag 填充，避免出现空结果。

## 6.0.1 2020-05-08

### 修复 bug

之前在搜索页面里，没有给 `filter.check` 前面加 `await`，导致在 `getIdList` 方法里，过滤器等于没生效。

这会导致储存大量不符合条件的作品 id，虽然之后在请求作品详细数据时会过滤掉不符合条件的 id，但对它们发出请求也会浪费很多时间。

现在对这个 bug 进行了修复。

## 6.0.0 2020-05-07

因为已经全面完成了小说的下载功能，所以增加了一个大版本号。

### 支持把小说保存为 epub 格式

### 支持把一些元数据保存到小说文件里

### 把一些选项移动到了“其他”选项卡里

## 5.4.0 2020-05-06

### 支持在小说页面里快速收藏、点赞

### 支持了小说收藏页面的批量下载、批量添加 tag

### 优化快速收藏功能

- 优化对图标的处理

之前，即使用户关闭快速收藏功能，本程序仍然会用自己的五角星 `☆` 收藏图标代替 pixiv 原本的心形图标。

现在用户关闭快速收藏功能后，本程序不会取代原本的心形图标了。

- 使用了新的添加收藏的 api

### 其他修改

- 建立了 `artwork` 和 `novel` 两个文件夹，把它们各自所属的文件放进去了。
- 修改了一些文件名和类名。
- 修改了 `getUserId` 和 `addBookmark` 这两个 API。
- 优化了图片查看器的一些功能和代码；修复了 esc 有时未生效的问题。

## 5.3.0 2020-05-04

### 初步支持小说下载 

对于常用的小说页面，都支持了批量下载。

因为已经可以实用了，所以先发布一版。

不排除可能存在潜在问题。

目前只能保存为 txt，不知 epub 的需求大不大，后续可以考虑做。还有一些便利功能考虑添加。

#### 一些需要注意的地方

1. 小说搜索页面，没有做预览功能。一方面这样比较麻烦，另一方面，小说的二次筛选的需求也许不大。

### 其他改动

- 生成文件名时，把不存在的标记去掉，而不是原样保存
- 检查有新版本时，提示图标的链接从 chrome 商店改成了 github。这是因为 github 才是最新版本（而且chrome商店里的可能会被下架）

## 5.2.1 2020-04-27

### 优化一些细节

1. 当因为体积问题跳过下载时，可能这个下载进度还是 0 或者很少，看着怪怪的，现在这种情况直接把进度条拉满。
2. 当设置了第一张图不带序号时，之前动图仍然会带着序号，现在去掉。

### 不把 changelog 打包进 dist 了

因为 changelog 有点太大了，接近 100KB 了，而且对普通用户来说也没用，所以不把它打包进 dist 文件夹了。

## 5.2.0 2020-04-24

### 可以设置文件体积限制

可以指定文件的体积范围，例如设置最小 1MB，最大 10MB，如果文件体积不符合要求，就会跳过这个文件的下载。

#### 没有发送 HEAD 请求

理论上应该是，先发送一个 HEAD 请求去获取文件的大小。如果符合条件，再发送下载请求。

但是这样做会很浪费时间。因为网络请求的过程基本是发送请求 - 等待 - 接收返回数据，等待 Waiting(TTFB) 通常会需要很多时间，批量下载时一个图片甚至有可能要等待 2 秒左右。如果先发一个 HEAD 请求，完成后再去发送下载请求，需要的时间就太长了。

所以现在本程序并没有发送 HEAD 请求，而是和以前一样直接下载，当接收到返回的数据时，再判断文件体积。当体积符合要求时，下载不受影响；当体积不符合要求时，中断这个请求。

目前这样唯一的负面影响是，接收图片数据之后再中断请求，终究还是会接收到一些数据。通常，当中断请求时，可能已经接收了几十 KB。不过这个问题看起来不大。

### 限制日志区域高度

## 谷歌商店审核又通过了 2020-04-23


## 谷歌商店审核未通过 2020-04-20

>您的产品不符合我们的计划政策的以下部分：
>用户数据隐私

>您的产品违反了此政策的“权限使用”部分，该部分要求您：

>必须请求获得为实现该产品的相关功能或服务而需具备的最基本权限。

>在可以使用多项权限来实现某个功能的情况下，必须请求获得最不需要访问数据或功能的那些权限。

>不得尝试通过请求可能会给尚未实现的服务或功能带来好处的权限为您产品的未来发展提供保障。

下载器就这么几个权限，没有滥用权限，也没有请求多余的权限。

最近的更新也没有添加新的权限。

我服了。

我详细的描述了一番各个权限的用途，然后重新提交了审核。

审核人员若是仍然拒绝，那就算了。

我记得我上个账号被连续拒绝两次之后，账号被封了。不知道现在会不会历史重演。

如果这次被拒绝，并且账号没被封，还可以尝试提交的话，预计会去掉以下部分：

1. 去掉从 github 检查版本更新的功能
2. 去掉 pixivision 的下载功能

## 5.1.6 2020-04-16

### 修复 bug

判断黑白图片里，加载图片时可能网络请求失败，对此加以处理。

### 其他优化

在搜索页面，p 站的筛选选项可以设置图片宽高在 xx 以下，之前下载器没有发现这个选项，现在进行了适配。

## 5.1.5 2020-04-15

在下载器底部添加了 fanbox 下载器的链接。

## 5.1.4 2020-04-14

### 修复 bug

过滤器的函数 `filter.check` 改成了异步，但是一些调用它的地方没有加上` await`，导致过滤失效，现在修复。 

## 5.1.3 2020-04-13

### 修复 bug

之前，检查“只下载已收藏”设置的代码有 bug，如果没有传递要检查的参数，那么这两个检查始终返回 false。实际上应该返回 true，现在修复。

### 其他优化

检查黑白图片时，如果加载图片时遇到错误，会捕获错误进行处理。之前直接抛出错误导致下载器无法继续运行了。

## 5.1.2 2020-04-08

### 修复 bug

之前，检查图片宽高、检查图片宽高比的代码有 bug，如果传递的参数里没有宽高，那么这两个检查始终返回 false。实际上应该返回 true，现在修复。

### 保存输入的 id 范围数字

之前没有保存输入的 id 范围数字，但是却保存了开关。当用户开启 id 范围设置，然后刷新页面，这个设置还是开启的，但是后面的输入框里是空的，抓取时会报错提醒。

现在对此进行修复，保存了用户输入的 id 数字。

## 5.1.1 2020-04-07

### 判断页面类型的时机提前

在 getPageType 里，对于下载器不支持的页面类型，会抛出一个错误。

扩展清单里，指定的运行范围是 pixiv.net 的所有页面，但是有些页面下载器不支持。之前，在不支持的页面上，仍然会添加下载器的面板。这是因为代码运行时先添加了面板，之后才检查页面类型。现在先检查页面类型，更加的合理。

## 5.1.0 2020-04-02

### 可以设置动图转换线程

在设置线程数字的后面加了个提示。

1. 同时转换多个动图会增加资源占用。
2. 转换动图时，请保持该标签页激活，否则浏览器会降低转换速度。

其实还有些没补充的，因为补充的话文字可能会太多了。

1. 如果资源占用太多，可能会导致页面崩溃，或者浏览器崩溃。（后果自负哦）
2. 保持该标签页激活，只需要该页面在浏览器里是直接显示的就行，不需要让这个页面一直保持显示在屏幕上（那样就做不了其他事情了）。
3. 保持该标签页激活的方法：第一种方法，不要切换到其他页面。但是这样就不能浏览其他网页了；第二种方法，把这个标签页拖出来形成一个单独的窗口，这样这个标签页始终是激活的，你可以回到之前的窗口浏览其他网页，也不会影响转换。
4. 动图的转换数量不会超过下载线程数。也就是说同时下载几个，最多也就只能同时转换几个，不能无中生有。

### 其他修复

修复了一些情况下，网页语言是中文，但是赞助链接显示的是 patreon 的情况。

## 5.0.0 2020-04-01

### 可以过滤彩色或黑白图片

我下载时不想要黑白图片，但是有些黑白图片分类是“插画”，不是“漫画”。而且也没有“漫画” tag，导致无法排除。现在增加了这个设置，进行排除。

如果设置了过滤彩色或黑白图片，过滤器会检查图片的平均颜色，判断这个图片是彩色的还是黑白的。

**注意：**这个方法并不算完美。虽然程序判断颜色是没错的，但是实际使用中，掺杂了其他因素，就显得不完美了。

一个和用户主管意愿有关的问题：如果有个图片整体是黑白线稿，但是部分涂抹了一点颜色；或者背景色是略微带点彩色的。这样的图片会被程序判断为彩色图片。如果用户排除黑白图片，排除不了这种。这很遗憾。

#### 可能会导致错误结果的因素

##### 1. 宽容度

宽容度可能会误伤（但一般来说问题不大）。灰色图片的 R G B 三色应该是相同的颜色，例如 `200 200 200`。但是我加了一个数值为 1 的宽容度，这样类似于 `200 200 201` 的图片也会被认为是黑白图片。所以偶尔会误伤，但情况很少；而且即使误伤了，这样的图片也很接近黑白图片，关系不大。

##### 2. 预先判断第一张图

下载器会先对每个作品判断第一张图，第一张图会影响后面图片是否保留。

如果一个多图作品第一张图的颜色和后面图片不同，可能会有误判。假如一个作品第一张是黑白图，后面是彩图，用户设置不下载黑白图，那么由于第一张图不符合要求，所以整个作品就全被排除掉了。这会造成失误，但是这样的作品很少。第一张是彩图后面是黑白图的比较多，而大部分人是喜欢保留彩图的，所以此时不会造成误判。

第一张是彩图，后面是黑白图的示例：`https://www.pixiv.net/artworks/80417958`

##### 3. 缩略图不准确的问题

使用的缩略图是 48x48 的 mini 尺寸。

这个缩略图是方形的，原图如果不是方形，那么周围多余的部分会被裁掉。而且缩略图尺寸比原图小。这两个因素都可能导致计算结果和原图不一致。

##### 4. 缩略图加载失败时，默认为是彩色图片 

下载器需要加载缩略图，然后判断图片颜色。如果加载缩略图失败，则把它当作是彩色图片。

如果这个图片实际上是黑白的，此时就会误判。

##### 5. 取平均值的方法本身就不够准确

因为是取平均值，所以有的图明明是彩图，但如果各种颜色分布比较平均的话，会被认为是黑白图片。

例如一个图片，三分之一是纯蓝色（0,0,255），三分之一是纯绿色（0,255,0），三分之一是纯红色（255,0,0），平均值是(85,85,85)，就会判断为黑白图片。

除了上面这个例子，有些图一部分是黑色，一部分是各种颜色都有的彩色，也可能被认为是黑白图片。

-------

在程序的处理上，要注意：

1. 不要再加大宽容度，因为宽容度哪怕再增加 1，引起的误伤都是很可怕的。
2. 第一道检查，是在抓取阶段，获取每个作品的详细信息时进行过滤。
3. 第二道检查。是在下载时进行检查。这是因为抓取时只能检测第一张的缩略图，有些作品第一张图的颜色和后面不一样，所以后面的图有必要进行一遍检查，以免有漏网之鱼。

#### ImageData 的数据结构

ImageData 是 Uint8ClampedArray 类型，里面包含着所有像素的信息。

每个像素有四个数字： r 值、g 值、b 值、alpha 值。

在 ImageData 里的排列顺序是逐行扫描。

#### 获取平均颜色的效率

不计算加载图片、绘制图片的部分，只计算从 ImageData 获取平均颜色的时间。

示例：

`https://www.pixiv.net/artworks/80358290`

cpu：I3-6100

第一张图是在抓取时使用缩略图计算的，缩略图尺寸约为 48*48，计算时间一般在 5 ms 以下。

第二张图片分辨率约为 2000*4000，是对原图进行计算的，时间在 600 ms 左右，极端时候可能有接近 1 秒。

在个效率是可以接受的。

### 修复了 pixivision 的一些 bug

主要是命名方面的，有时候会产生错误的结果，进行修复。

### 其他优化

1. 修复了重置表单时的问题。

- 之前，如果一个子选项是打开的，重置时关闭了，但这子选项没有被隐藏，现在修复。

- 之前，如果重置时改变了一些单选、复选框的值，其对应的 label 没有根据新的值，改变自己的颜色。现在修复。

2. 把 第一张图不带序号 的选项从默认开启改为默认关闭。本来就应该是默认关闭的，之前失误了。

## 4.9.1 2020-03-30

### 增加了 patreon 赞助连接

会在主面板下方显示赞助链接。

[Patreon Page](https://www.patreon.com/xuejianxianzun)

## 4.9.0 2020-03-30

### 新增设置：第一张图不带序号

去掉每个作品第一张图的序号。

效果是单图不带序号，多图的第一张也不带序号。第一张之后的图片要带序号，防止重名。

## 4.8.0 2020-03-29

### 设置是否下载单图作品

之前只有个多图的选项，可以选择是否下载多图。有人提过希望能够选择是否下载单图。所以这里加了这个选项。

另外，因为这个选项可以控制是否下载多图，所以对之前的多图下载设置做出了调整。

### 调整一些选项的位置

“动图保存格式”不属于抓取部分，应该属于下载部分，所以把它放进下载选项卡里面了。

### 响应动图保存格式的修改

例如，抓取时动图保存格式是 webm，数据里储存的后缀名就是 webm。之前，在下载途中，如果用户把格式改为 gif，下载器不会响应这个修改，依然把所有动图转换为 webm。现在，用户修改格式之后，后续下载的文件会响应用户的修改，转换为对应的格式。

### 优化过滤器的性能

之前，过滤器 Filter 会对每个作品检查所有过滤选项，最后判断结果，这是浪费效率的。

之前，假如有 10 个判断条件，某个作品第一个判断条件就不符合，但过滤器仍然会继续检查剩余的判断条件。这是不必要的，现在过滤器遇到某个条件不符合要求时，不会再进行后续的判断了。

### 降低更新 token 的频率

之前每次初始化下载器都会更新 token，也就是说每打开一个 pixiv 页面就会请求一次特定页面，获取它源码里的 token。这太频繁，没有必要。现在设置成每隔 5 分钟检查更新一次，大大减少了不必要的请求。

## 4.7.0 2020-03-27

### 设置收藏数量，可以设置区间

以前只能设置一个值，也就是最小值，要求收藏数大于这个数字。

现在改成最小值和最大值，并且可以任填一个。既可以要求大于某个数字，也可以要求小于某个数字，也可以同时要求，设定一个区间。

### 其他优化

之前在搜索页筛选时，对于 R-18G 作品，筛选后显示的是 R-18，现在可以正确显示为 R-18G 了。

### 代码格式的变化

有一台电脑重装系统之后，我配置好了开发环境，尝试编译本程序，但是编译后有 70 个 change，发现是代码格式的问题。

有 3 个地方的变化:

1. `function` 关键字后面应该有个空格的，之前没有，现在加了空格
2. 箭头函数只有一个参数时，之前没有加括号，现在加了括号
3. 对象成员、数组项的最后一项之后加了逗号

我看了看 prettier 的配置文件，确实会产生现在的结果。为什么之前产生的是其他结果呢？可能之前的环境太乱了吧，现在新的代码风格挺好的，保持下去吧。

### 截断用户名后面的 @ 的调查

有些用户会在名字后面加 `@`，后面经常写着漫展摊位，或者寻找工作。我考虑要不要加一个功能，自动阶段 `@`，只保留前面的真正的用户名部分。

但是在群里调查一番，发现不太好这样做。

1. 有些用户用的不是 `@` 做分割，而是竖线 `|`，也许还会有别的。
2. 这样可能误伤，比如有些用户名里本来就带 `@` 的，程序难以分辨。

### 单图去掉 p0 后缀的调查

有些人想要单图的 {id} 去掉 p0 后缀，比如：

```
81243345_p0.png
# to
81243345.png
```
如果是单张图片的作品，直接去掉 p0；如果是多 p 图片，则只去掉第一张的 p0。

但是我在 QQ 群里投票调查，需要此功能的人是很少数。所以暂且不打算加上这个设置。

## 4.6.0 2020-03-17

### 尝试解决搜索结果乱版的问题

在搜索页面的筛选结果里，之前下载器的 class 都是和页面里保持一致，但是 p 站可能会修改页面 class，它一改，搜索结果就乱版了。

现在我把样式复制了下来，把class 修改为自订的，不用紧跟 p 站更新了。预计这样可以很大减少搜索结果乱版的问题。

### 增加设置项的行间距

之前设置项的行间距是 24px，这和当初设置项太多有关，这样更紧凑一些，节约纵向空间。现在设置项已经分到选项卡里了，把行间距加大到了 26px，整体宽松一些，视觉效果更和谐美观。


## 4.5.0 2020-03-15

### 把设置选项放进选项卡里

因为设置选项太多了，原本全都竖着排下来，高度比较大，时不时就会出现滚动条。尤其是出现了下载部分之后必定有滚动条，下载时经常需要上下滚动查看，很不方便。

关于这个我还做了个问卷调查，31个用户参与，有52%的用户觉得太长有些不方便。

现在按照功能区别，把这些选项放进了选项卡里面，基本不会出现滚动条。

目前选项卡分成了3个：抓取、下载、其他。

### 界面上的其他调整

1. 因为这个改变，现在把抓取部分和下载部分都放进 form 里了。
2. 移除折叠按钮.原本折叠按钮会折叠选项区域，显示按钮区域。现在按钮也包含在选项区域里了，一折叠就什么都不显示了，所以去掉。
3. 预览文件名 做成了一个单独的按钮
4. 一些非抓取的功能按钮放到“其他”里面，比如 给未分类收藏添加 tag 就是如此。
5. 之前选项名字都是6个汉字，为了整齐好看，但是有时候难免词不达意。现在分开之后没有那么多选项同时排在一起了，所以不整齐也不会显得很难看，我就把一些选项的字数增加了，使其更容易理解。
6. 最近在p站看到国内有个众筹赞助平台“爱发电”，我创建了主页，它会显示在下载器的底部。

https://afdian.net/@xuejianxianzun

### 搜索页面适应改版

同时对于去除热门作品上的遮挡，修改了选择器，使其更稳定。今天发现这个地方的 class 不同 tag 的页面里可能不一样，好厉害。

现在搜索页筛选完之后不会自动显示下载面板，这是为了方便直接查看筛选结果，如果满意再下载，不满意则二次筛选。

如果筛选完之后显示了下载面板，想要查看筛选结果的话，需要先关掉下载面板才能查看。对你来说怎样更方便？

我在qq群里做了投票，最终25：:10 保持现状：显示。大部分人表示保持现状继续不显示。

## 4.4.1 2020-03-10

### 优化一处提示

之前，在作品页面如果抓取数量设置为 -1，之后不论是点击“抓取新作品”还是“抓取旧作品”，出现在顶部日志里的提示都是“向下获取所有作品”。这个表达不准确，现在修改为根据“抓取新作品”还是“抓取旧作品”，显示对应的提示。

## 4.4.0 2020-03-09

### 添加开关：启用快速收藏

这个选项可以控制：

当你点击下载器添加的收藏按钮(☆)，把作品添加到书签时，是否自动添加这个作品的 tag。

原本在搜索页面，筛选后的收藏按钮仍然是“心”，为了标识这是下载器添加的收藏按钮，把它改成了五角星。

## 4.3.0 2020-03-08

### 可以设置多图建立文件夹时的命名

多图建立文件夹时，可以选择使用作品 id 命名文件夹，或者遵从文件名命名规则。

## 4.2.4 2020-03-08

### 使下载面板的标题栏始终显示

标题栏上包含一些有用的按钮，最常用的就是关闭按钮，和折叠设置按钮。

之前如果下载面板内容太长，出现了滚动条，滚动到下方之后，标题栏就不显示了，要点击这些按钮还要先滚动上去。现在进行了优化，使标题栏始终显示在顶部，随时都可以点击。

### 其他优化

当下载器面板显示的是英文时，多图设置那一行因为文字较多会产生一个换行，现在精简了文本，使其不产生换行（强迫症福音）。

## 4.2.3 2020-03-06

### 适应搜索页面 html 改版

## 4.2.2 2020-03-05

### 调整命名规则下拉框里，选项的顺序

大致依照常用程度、相关性，从上到下重新排列了顺序。

## 4.2.1 2020-03-05

### 适应搜索页面 html 改版

### 去掉搜索页面热门作品的遮挡

热门作品上面覆盖了会员购买链接，导致无法点击。现在移除遮挡的部分，使热门作品可以点击。

### 优化 getUserId

修改了一些元素的选择器，可能会使这个 api 稳定一些

## 4.2.0 2020-03-01

### 移除命名标记 {p_user} {p_uid}

```
{p_user} 当前页面的画师名字
{p_uid} 当前页面的画师id
```

这俩标记只能在画师页面和作品页内使用，其他页面不能使用。很多用户对此感到困惑。

这是因为这俩标记代表当前页面里的作品属于**某一个**画师，这时就会使用这个画师的信息。其他页面可能有多个画师的作品混杂，没有办法说“这个页面是属于哪个画师的”，所以不能用。

因为这俩标记带来很多困惑，而且使用场景受限，使用它们的时候，大部分情况下可以用 {user} 和 {uid} 替代，所以去掉了这俩。

**注意：**

作品页内，“抓取相关作品”功能时，这俩标记会和 {user} 和 {uid} 产生的结果不同。不过这个情景里，这俩标签也不太适用，所以问题不大。

## 4.1.0 2020-02-24

### 可以为多图作品自动建立文件夹

增加了“多图建立目录”选项，可以在下载多图时，使用作品 id 自动建立文件夹存放。

（如果只下载多图的前一张图片，不会建立文件夹，下载多张时才会建立）

### 修复 bug

最近一些版本里存在一个显示上的 bug，当下载中暂停任务，之后继续开始下载时，已下载数字会变成 0，这属于初始化下载进度条里的一个 bug，现在进行了修复。

## 4.0.5 2020-02-22

### 优化一些功能体验

#### 在添加抓取结果的数据时，进行了去重

今天有人说在搜索页面筛选时，有时会出现一些作品显示两次。我自己测试，有时候有这个情况，有时候又没有，没搞清楚问题所在。其实正常来说不应该有重复的，现在在添加抓取结果时，会先检查这个数据是否已经添加过，避免重复添加。

#### 转换动图出错 ReadZIP error 时，跳过这个任务

转换动图时，下载器会先下载动图的 zip 文件，然后读取里面的内容，但有时候因为网络（梯子）的问题，下载的 zip 文件是损坏的，就会触发这个错误 `ReadZIP error`。

之前，发生这个错误时，没有进行对应的处理，只是提示一条错误信息。这就导致出错任务的下载线程被“堵住”，现在增加错误处理，跳过这个下载。

## 4.0.4 2020-02-18

### 增加图片网址的域名

今天有用户下载时，发现图片网址的主域名是 `techorus-cdn.com`，这是之前没有出现过的，所以把这个网址增加到了 permissions 里。

```
https://tc-pximg01.techorus-cdn.com/img-original/img/2020/02/18/02/59/21/79568084_p0.png
```

如果以后 p 站继续增加新的域名，则考虑吧 permission 里的网址匹配规则改为 `<all_urls>`。

## 4.0.3 2020-02-18

### 修复 bug

#### 修复初始化时恢复设置的问题

之前的修改导致页面初始化时，没有对“折叠设置区域”的设置做出相应，现在修复。

#### 修复 getUserId 的问题

对 DOM.ts 里的 getUserId 进行了更新，因为页面上一些 class 变了，导致某些时候会发生错误。

 如 www.pixiv.net/artworks/79399027 ，作品简介里出现了另一个用户的链接，如果 getUserId 最后是从 body 里匹配，会匹配页码源码里第一个符合用户 id 的链接，就匹配成了另一个用户。要尽量避免 getUserId 从 body 里匹配。

## 4.0.2 2020-02-11

### 适应改版

上次改版忘记修改筛选作品按钮使用的 class 了，现在修复。

## 4.0.1 2020-02-06

### 适应搜索页面 html 改版

p 站搜索页面，作品得 html 变了。其实只是 class 变了，导致下载器现实的结果是乱版的，现在修复。

p 站现在的 clas有很多是分两部分的，如下：

```<div class="sc-fzXfQq cFrFLf">```

第一部分以 `sc-` 开头，这部分也可能会变，不过第二部分变化的更频繁一些。

注意适应此改版时，也应一同修改 countClass。

## 4.0.0 2020-01-20

### 美化表单

美化了复选框和单选框，着实费了些功夫。也把 input 从 label 里脱离出来了。

效果比较满意，不仅更美观，而且高亮了选项和对应的 label 文本，也让已选择的选项更醒目，更容易辨识。

#### 技术细节

美化之后的控件一般有三个元素：

1. 原控件，隐藏了，但仍可通过 tab 选择与改变
2. 美化的按钮，点击可以改变控件的值
3. label 文本，当它对应的控件被选中时，label 会高亮

这三个元素都可以改变控件的值，所以都需要能触发 settingChange 事件。

SaveSettings 类在原控件的值变化时触发 settingChange 事件；

Settings 类在点击美化按钮、label 文本时触发 settingChange 事件。

##### 美化后的复选框：

```
<input type="checkbox" name="downType2" id="setWorkType2" class="need_beautify checkbox_common" checked="">
<span class="beautify_checkbox"></span>
<label for="setWorkType2"> 动图 &nbsp;</label>
```

##### 美化步骤：

1. 给 input 添加增加 class
2. 添加美化的按钮元素，并给它添加 class

##### input 上使用的 class：

|      class      |                 说明                 |
| :-------------: | :----------------------------------: |
|  need_beautify  | 说明这个控件需要美化，css 会隐藏掉它 |
| checkbox_common |         在普通的复选框上使用         |
| checkbox_switch |       在作为开关的复选框上使用       |
|      radio      |            在单选框上使用            |

##### 美化按钮上使用的 class：

|       class       |         说明         |
| :---------------: | :------------------: |
| beautify_checkbox | 美化按钮表现为复选框 |
|  beautify_switch  |  美化按钮表现为开关  |
|  beautify_radio   | 美化按钮表现为单选框 |


### 优化选项逻辑

对于可选的选项（可以选择启用或不启用的设置），应该统一加个开关。

以前的交互逻辑不统一，很混乱，现在进行统一。

1. 有的没有加开关

>设置宽高条件 ? 0 and   or  0

用默认值为 0 变相起到了不限制的作用，但是没有加开关

2. 有的把开关与条件并列了

>设置收藏数量 ?  不限制   大于  1000

>设置宽高比例 ?  不限制   横图   竖图   宽高比 >= 1.4

>设置 id 范围

用“不限制”做开关，但是不限制和其他几个条件并列的，并不是真的开关。

3. 有的比较合理，是 开关 + 条件

> 设置投稿时间 ? 开关 时间条件

这是因为这些选项是不同时期加上去的，想法不一样，而且也没有统一的标准。现在决定都改成开关+条件。

第二种情况里的 “不限制” 按钮之前是单选框，保存的值是其 value（字符串），现在改成了开关（复选框），值是 boolean。所以把“不限制”改为开关之后，需要给开关起一个新名字，不能沿用“不限制”的 name，避免与旧版本的已保存设置冲突。

### 当选项未启用时，隐藏后面的设置项

例如：

> 设置投稿时间 ? 开关 时间条件

以前是把开关和设置项一起显示的，现在改为选项未启用时，隐藏后面的设置项。开关打开时再显示。

### 其他变更

- 保存宽高条件设置。以前不会保存，从此版本开始会保存。
- 保存设置宽高比例。同上

### 修复 bug

之前作品页内切换图片查看器的事件没有进行解绑，导致某些时候报错，但不影响使用。现在修复。

### 其他问题

图片查看器全屏之后，本该按一次 esc 退出全屏，再按一次 esc 退出查看器。

但是第一次按 esc 退出全屏之后，短时间内再按 esc 无效，要过一点时间再按。在这期间按键似乎不生效。不知道为什么。

## 3.9.7  2020-01-14

### 修复 bug

3.9.5 版本检测页面里有用户页面链接 /users/ 则视为内容已加载，开始获取 pageInfo。一般来说没问题，但是有些页面内容里确实没有 /users/ （例如搜索页面结果为0的时候），这时候就会导致一直没有开始获取 pageInfo。现在修复了这个问题。

## 3.9.6  2020-01-13

当检测到新版本时，点击更新图标会打开 Chrome WebStore 的安装页面。

之前是打开 GitHub 页面，现在改为 Chrome WebStore 页面。

## 3.9.5  2020-01-12

### 修复 bug

用户页面的 url 改版之后，在这些页面 {p_tag} 失效了，进行修复。

把获取 tag 的操作统一放在了 API 里。

### 优化代码

1. 之前搜索页面“顶部”一栏的 url 是特别的，包含 `/tags.php`，今天看了下没有了，所以把这个从判断条件里去掉了。
2. 最近页面刚加载时，执行 getPageInfo 报错，因为此时页面内容实际还没加载。应该是 p 站最近又做了一些修改，对这个问题进行修复。

## 3.9.4  2020-01-12

### 修复 bug

当使用 {p_title} 命名标记时，一开始下载时是当前页面的标题。如果下载途中跳转了页面，{p_title} 就变成新页面的标题了，这样就会产生两个文件夹。现在修改为一次下载中始终会使用一开始的页面的标题。

其实这个问题以前就解决过，可能前些时候重构又搞得复发了，现在修复。

## 3.9.3  2020-01-09

### 修复 bug

上版本导致快速筛选功能出现在了不该出现的页面，现在修复。

## 3.9.2  2020-01-08

### 适应用户页面 url 的改变

今天发现用户页面 url 变了，而且似乎是短时间内就面向所有用户启用了。新版的 url 如下：

注意：如果设置了语言为英文，则会在主域名后多出 `/en`

- 用户主页

https://www.pixiv.net/users/3869665

- 所有作品

https://www.pixiv.net/en/users/4493551/artworks

- 所有作品带 tag

https://www.pixiv.net/en/users/4493551/artworks/Fate%2FGrandOrder

- 插画页

https://www.pixiv.net/users/3869665/illustrations

- 插画页带 tag

https://www.pixiv.net/users/2188232/illustrations/ghostblade

- 漫画页

https://www.pixiv.net/users/544479/manga

- 漫画页带 tag

https://www.pixiv.net/users/544479/manga/%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%8A%E3%83%AB

- 小说页

https://www.pixiv.net/users/46678986/novels

- 收藏页

https://www.pixiv.net/users/3869665/bookmarks/artworks

- 收藏页带 tag

https://www.pixiv.net/users/9460149/bookmarks/artworks/FGO

- 收藏页非公开，带不带 tag 都是在最后加查询参数

https://www.pixiv.net/users/9460149/bookmarks/artworks?rest=hide

### 适应页眉改变的影响

页眉换成了新的，导致头部没有之前的 `header` 标签了。对此做了适配。

这个问题还导致搜索页面的快速收藏没有插入，现在修复。

### 代码优化

分离出了搜索页面的快速筛选功能，独立成 FastScreen 类。

## 3.9.1  2020-01-07

### 优化代码

#### 切换显示设置表单

现在代码细分了，切换设置显示表单的代码需要改改了。因为切换按钮在 CenterPanel 里，给它绑定事件却在 InitSettings 里。优化了此部分代码。

#### 优化 InitUserPage

优化了 InitUserPage 抓取作品 id 列表之后的逻辑。

#### 优化了 TitleBar 的闪烁

当 TitleBar 让页面标题闪烁之后，如果用户切换了页面，标题被重置了，则闪烁效果就出不来了。之前在此情况下，闪烁代码也不会停（虽然看不到效果了，但还在不停修改标题），现在在此情况下会停止闪烁了。

## 3.9.0  2020-01-05

### 优化下载进度条

#### 下载进度条独立成类

之前 DownloadControl 操作总下载进度条，Download 操作自身的子下载进度条。这部分的逻辑非常混乱，现在把下载进度条独立出了 ProgressBar 类，舒服多了。

#### 优化响应下载线程设置的变更

以前在抓取完成后并没有重新生成子进度条，开始下载时才重新生成。这样有个问题，如果第一次下载完之后，修改了下载线程数量，并且没有设置自动下载，那么第二次下载就绪时，子下载进度条没有重新生成，数量就对不上新的下载线程。现在可以及时对上了。

### 优化下载出错时的处理

下载时状态码出错时，如果是 404 则可以明确的提醒，其他的状态码目前无法处理。

之前，遇到无法处理的情况时会终止执行这个下载线程，等于这个下载线程“卡死”了。现在为无法处理的情况也添加了提醒，不会终止下载线程、卡住了。

### 修复 bug

之前的更新导致搜索页面“手动删除”模式中，每删一个作品，都会显示下载面板，现在进行修复。

但目前还有些其他问题，比尚未开始筛选时，点击清除多图作品、手动删除等，仍然有反应，这是因为这些按钮处于另一个类中，状态没有完全互通。等以后看怎么解决吧。

## 3.8.0  2020-01-03

### 合并 init 和 crawl 

之前初始化一个页面是分两部分的，`InitxxxxPage` 初始化按钮，`CrawlxxxxPage` 初始化抓取流程。由于这两个部分是强耦合，有些地方需要直接交互；这两种类也不具有通用性，所以把它们合并了，现在都放在 `InitxxxxPage` 类里了。

### 其他代码优化

### 优化细节

搜索页面第一次筛选之后，之前不会在预览部分显示抓取到了多少个。现在会显示了。

## 3.7.0 2020-01-02

### 保存“设置收藏数量”选项

以前不会记住此设置，现在记住了此选项。

以前只有一个输入框，输入的值等于 0 相当于不限制，大于 0 才限制。现在为了便于使用，为其增添了“不限制”或者“大于”的选项按钮，点击按钮即可更改限制状态。

### 优化了保存设置的代码

### 拆分出书签页面的抓取

之前书签页面的抓取不是一个独立的类，而是在用户列表页之内的，现在拆分出来，并分配 pageType 为 3。

### 修复 bug

今天发现收藏页面抓取带斜杠的 tag 时抓取失败，如 `Fate/GrandOrder`，原因是重复进行了 `encodeURIComponent`，现在修复了这个 bug。不清楚到底是何时开始出现的这个问题。

## 3.6.2 2020-01-01

### 修复 bug

1. 3.6.0 把右侧下载图标独立出来了，但是其执行时机放在了判断页面类型之前，导致即使是不支持的页面类型，也显示了下载图标。现在修复。
2. 修复了搜索页面二次筛选时，修改多图作品设置无效的问题。

### 优化预览文件名的性能

预览文件名时，如果文件数量很多，可能会导致页面卡住，很长时间无法操作。现在做了以下优化：

#### 减少生成结果耗时：

- 生成文件名预览结果时，使用数组储存字符串并 `join`，代替用加号 `+` 直接拼接字符串。
- 使用 for 循环代替 forEach（因为 for 循环的速度最快）

#### 优化渲染效率

卡顿的主要原因不在生成结果上，而是结果输出到页面上之后，页面重新渲染卡住了（花费了过多的时间，并且之后的操作也一直很卡）。

- 使用 class 代替行内样式 （具体效果不是很清楚）

```
<span style="color:#999;">76371902_p0.png</span>
改为
<span class="color999">76371902_p0.png</span>
```

- 减少同级元素节点的数量

优化前，假设 3000 个数据，每个产生如下结果：

```
<span class="color999">xxx</span>
:
<span class="color666">xxx</span>
/
<span class="color000">xxx</span>
<br>
<br>
```

每个结果产生 7 个节点，把所有结果拼接在一起之后产生了 21000 个**同级**节点。渲染极慢。

优化后，每条结果使用 `p` 标签包裹这些细碎的标签，这样只产生了 3000 个**同级**节点。虽然总节点数量增加了，但渲染效率却极大提高了。

```
<p class="result">
<span class="color999">xxx</span>
:
<span class="color666">xxx</span>
/
<span class="color000">xxx</span>
</p>
```

并且，优化之前使用两个 `<br>` 标签换行来做间隔，优化后去掉了 `<br>` 标签，改为给 `p` 标签设置样式来做间隔。这样减少了总的节点数量。

### 优化提醒

现在，当预览文件名，以及输出 url 时，如果没有抓取结果可用，会显示提醒。

### 优化 pageType 的判断

1. 之前旧的作品页网址已经不再使用了，所以从判断条件里去掉了，如：

```
https://www.pixiv.net/member_illust.php?mode=manga&illust_id=70558528
https://www.pixiv.net/member_illust.php?mode=medium&illust_id=65953727
```

2. 画师作品列表页的判断也做了修改，现在的列表网址如下：

```
https://www.pixiv.net/member.php?id=544479
https://www.pixiv.net/member_illust.php?id=544479
https://www.pixiv.net/member_illust.php?id=544479&type=illust
https://www.pixiv.net/member_illust.php?id=544479&type=manga
https://www.pixiv.net/member_illust.php?id=544479&type=illust&tag=xxx
```

3. 搜索页面的旧网址也不再使用了，从判断条件里去掉了。

```
old:
https://www.pixiv.net/search.php?s_mode=s_tag&word=saber

new:
https://www.pixiv.net/tags/saber/artworks?s_mode=s_tag
```

### 输出面板的性能测试

- 时间：2020-01-01
- 浏览器：Chrome 79
- CPU：i3-6100 
- 测试网址： [Fate/GrandOrder10000users入り](https://www.pixiv.net/tags/Fate%2FGrandOrder%2010000users%E5%85%A5%E3%82%8A/artworks?s_mode=s_tag)
- 数据量：24000 个图片结果

**说明：**
- 渲染耗时:从点击预览按钮，到页面可以操作的时间
- 复制耗时:从点击复制按钮，到复制完成的时间
- 时间向下取整，即后面可能有小数


#### 预览文件名

命名规则：

```{p_title}/{bmk}-{id}-{user}-{tags_translate}```

- 渲染耗时：6 秒
- 复制耗时：3 秒

#### 复制 URL

- 渲染耗时：2 秒
- 复制耗时：6 秒

## 3.6.1 2020-01-01

### 修复 bug

上版本导致画师作品列表页的页数默认值变成了"1"，现在改为原本的“-1”。

## 3.6.0 2019-12-31

### 增加了“预览搜索结果”的开关

如果抓取结果太多可能会导致页面崩溃，所以可能有的时候需要关闭预览功能。

打开预览时，始终不自动下载。关闭预览时，会依照自动下载选项处理。

### 优化 UI

之前表单部分中间插入了第一排按钮，比较怪异（也让代码里更难处理相关部分）。现在把按钮都放在表单外了，也规范了其他一些操作，插入元素使用插槽来规范。

UI 类进一步细化，拆分成了 Settings 类、RightIcon 类、CenterButtons 类、CenterPanel 类。 

### 优化设置表单

#### 把设置表单独立成了 Settings 类

#### 优化设置表单选项的编号

之前有的选项没有编号，而且编号的顺序已经乱了，现在重排编号。

#### 规范对设置表单选项进行显示/隐藏的操作

切换页面时先进行一次重置，显示所有选项，然后根据传入的选项，隐藏不需要的选项。

#### 设置表单的选项列表

*末尾的数字是该选项以前的编号*

1. 设置页面数量/设置作品数量 1
2. 下载作品类型 5
3. 多图下载设置 3
4. 动图保存格式 12
5. 设置收藏数量 2
6. 只下载已收藏 11
7. 设置宽高条件 4
8. 设置宽高比例 13
9. 设置 id 范围 15
10. 设置投稿时间 16
11. 必须含有 tag 6
12. 不能含有 tag 7
13. 设置命名规则
14. 添加字段名称 10
15. 始终建立文件夹 14
16. 设置下载线程
17. 是否自动下载 8
18. 预览搜索结果
19. 多图建立目录

### 优化预览文件名时的样式

对预览文件名做了优化，突出显示文件名，加大了每一条结果之间的间隔。

### 抓取首次登场作品 微调

之前在排行榜页面“抓取首次登场作品”时，不会遵从“设置作品数量”，一律从所有作品（最多 500 个）中筛选。

现在起，抓取首次登场作品也会遵从“设置作品数量”了。这一影响很小，一般情况下用户不会察觉到差别。

### 修复 bug

3.5.0 时，新增了一个状态 notAutoDownload，该状态优先于“自动下载”选项，让下载器不会自动开始下载。但是当时没有在切换页面时重置它的值，导致如果一开始打开的是搜索页，设置了不自动下载，之后无刷新进入其他页面也会不自动下载。现在修复此问题。

修复了没有开始筛选时，直接使用二次筛选按钮，提示“下载完成”的问题。现在会提示先进行筛选。

另外，之前在筛选完之后没有改变标题上的提示，现在加上。

## 3.5.1 2019-12-29

- 修复 bug

在普通的搜索页如 [アズールレーン
](https://www.pixiv.net/tags/%E3%82%A2%E3%82%BA%E3%83%BC%E3%83%AB%E3%83%AC%E3%83%BC%E3%83%B3/illustrations)，有两个作品列表，第一个是“熱門作品“列表，第二个才是要使用的作品列表。昨天测试时的页面没有“熱門作品“列表，没发现这个情况，导致出错。现在修复。

## 3.5.0 2019-12-28

### 可以在搜索页面预览结果了

可以在搜索页面预览抓取到的结果，并且通过各种筛选按钮进一步缩小抓取结果，只保留喜欢的图片下载。

#### 性能测试：

一个页面抓取并显示 4000 个作品，内存占用增加了 500-600 MB.

当作品数量较多时，进行筛选之后要重新显示作品，会有数秒的卡顿。

### 其他优化

在获取作品列表完毕后，显示统一的提示信息。以前这部分比较乱，现在规范了。

### 版本号更新的标准

版本号的增加是我自己决定的，但并非一直都执行相同的标准。所以现在定一下标准。

版本号分为三位。版本号的更迭应该以开发者角度（即代码层面的变更）为主，用户角度次之。这样开发者可以通过版本号的更迭知道代码是小改还是大改；用户只要知道新的版本号比旧的大就行了。

#### 大版本号更新

1. 比较大的代码重构
2. 后面小的版本号累积，到达当前大版本号上限

#### 次级版本号更新

1. 增删功能/选项，用户感受显著的
2. 优化代码、适应改版等，导致代码有较多变动
3. 修复严重 bug

#### 末位版本号更新

1. 增删功能/选项，用户感受不显著的
2. 优化代码、适应改版等，导致代码有少量变动
3. 修复不严重的 bug
4. 优化文本

### changelog 的更新项使用小标题

之前每个版本的主要更新项都是用列表 `-` 展示，但这样不利于再往下细分层级，有时候感觉不便。所以从此版本开始，改为用次级标题 `#` 号依次往下细分。

## 3.4.1 2019-12-26

- 修复 {date} 标记的格式问题

3.3.5 版本导致 {date} 标记的月份、天数没有补上 0，现在补上。

修复前后如 12-1-1 -> 12-01-01.

## 3.4.0 2019-12-25

- 优化下载出错时的重试功能

以前下载出错重试时，会暂停所有下载，然后继续下载。现在只会重新下载出错的那个任务，不会暂停所有任务，不会影响其他下载。

现在有两种重试情况。

1. Download 会重试从 pixiv 下载图片失败的情况，每个任务有最大重试次数。

2. DownloadControl 会重试浏览器下载任务失败的情况，让 Download 重新下载它，不限制重试次数。

- 其他修改

这个版本还取消了向浏览器发送下载任务时，每个之间 200ms 的间隔。目前测试没有发现问题，希望真的不会有问题。

## 3.3.6 2019-12-24

- 优化代码

下载作品类型的 3 个选项，之前在代码里是把它们的结果合并成一个字符串，并且是取反。

如 `√插画 ×漫画 ×动图` 分别用 `0 1 2 `表示，保存“排除的类型”，结果为字符串 `12`。

这比较反直觉，而且设置和保存这几个选项都比较麻烦。现在拆分成 3 个单独的变量，每个选项用一个布尔值保存。

- 404 问题重试下载

最近 p 站出现了一些图片下载返回 404 的问题，但再过一小会儿访问又正常了。普通的浏览看图也会有遇这个问题。Reinford  让下载器在 404 时进行重试，解决了个这个问。

## 3.3.5 2019-12-20

- 可以设置下载作品的时间范围了

因为目前只有在获取作品详细信息时才有“createDate”数据，所以在获取作品列表时无法预先检查它。

```
// 示例网址
https://www.pixiv.net/artworks/78339797

// 原始数据是 UTC 时间
createDate: "2019-12-17T09:00:09+00:00"

// 网页上显示的是用户本地时间
2019年12月17日 17:00
December 17, 2019 5:00 PM
```

上面那样只是显示的不同，实际上是同一个时间。

用户输入的也是本地时间，但是和 createDate 比较时，不需要额外的转换，这是因为它们 js 内部比较时间（以及 getTime 方法）都会转换为 UTC+00:00 的时间。

- 优化代码

为保存 option 的一些操作创建了公共函数，使代码更简洁。

- 其他

{date} 命名标记之前是截取 createDate 的日期部分，也就是 TC+00:00 的，这次更新改成了本地时间，和网页上一致。

## 3.3.4 2019-12-19

- 可以设置下载的 id 范围了

增加了“设置 id 范围”选项。

- 修复 bug

修复某些极端情况下，获取未分类书签数量错误的问题。

比如实际上有很多，但第一页的 20 个都是无法访问的，返回的数据就是空的。之前把“返回的数据为空”当作抓取完了，但是面对这个极端情况就会出错。现在修复了这个问题。

## 3.3.3 2019-12-18

- 现在可以排除多图作品了

增加了“多图作品设置”选项。

- 限制动图同时转换数量

如果同时转换多个动图，会占用较多的内存和 CPU 使用率。有些用户在下载动图时因此出现页面或浏览器崩溃的情况。Reinford 提议同时只转换一个动图，为了程序的稳健性我采纳了这个建议。

其实设置下载进程为较小的数字，如 1 或 2，同时转换动图的数量不会超过下载进程，所以也不容易崩溃。但是有些用户只想着 5 线程全开，转换动图当然容易崩溃了。

## 3.3.2 2019-12-17

- 修复文本错误

## 3.3.1 2019-12-17

- 快速下载单图也可以创建文件夹了

在作品页内会显示这个选项：`始终建立文件夹`，启用就会始终建立文件夹。

## 3.3.0 2019-12-16

- 代码模块化

对代码的优化进行了一段时间，现在可以拆分为模块了。

- 优化图片查看器的体验

之前有时候点 1：1 全屏查看时，图片放大到 100% 后瞬间又变回来了。现在不停循环执行放大到 100%，解决此问题。

## 3.2.6 2019-12-12

- 优化代码

使用发布者-订阅者模式进行了一些解耦。解耦之后类的封装性更强了，也更内聚了。有一些耦合比较合理的没有强行解耦，不然到处都是事件监听了。

消除了一些元素、变量开头的 “xz” 字样。剩下少数没有修改，是为了标识这是下载器的特有元素。

将 output 相关的代码从 ui 里挪到 Output 类里，更清晰。

将设置下载进度条相关的代码从 ui 里挪到 DownloadControl 类里，更清晰。

css 里的样式分类归纳了一下，不那么乱了。

下载后把 xhr 和 file 设置为 null *，试图让内存回收和本地缓存文件回收更快捷。但目前测试来看似乎一部分人的电脑上无效，一部分有效。不知哪种情况多一些。

* Reinford 测试发现 xhr 请求在下载大于 5 MB 的文件时，chrome 会在硬盘生成缓存文件，如果一个页面里下载了很多大文件，那么硬盘上会堆积很大体积的缓存文件，直到页面被卸载才会删除。把 xhr 设置为 null 可让 chrome 及时清理无用的文件。但目前测试结果不是所有人的电脑上都有效。

其他代码优化。

## 3.2.5 2019-11-29

- 修复一些 bug

- 优化代码

把一些 public 的属性和方法改成了 private、protected，优化了封装，减少了不必要的暴露。

在需要的地方使用存取器，使得修改状态更加方便，相关代码易于管理。

也对其他地方进行了一些优化。

## 3.2.4 2019-11-27

- 修复 bug

之前屏蔽广告添加的一处 class，现在变了位置，导致屏蔽了正常元素。修复之。

## 3.2.3 2019-11-26

- 尝试当下载的文件名异常时，给出提醒

有些扩展接管下载导致本扩展下载后的文件名是 UUID 格式的，很多人问这个问题，现在找到了个检测此问题的办法，出现问题时在日志里提示。

## 3.2.2 2019-11-26

- 修复 bug

上个版本随手修改出了 bug，还好及时发现，赶紧修复下。

## 3.2.1 2019-11-26

- 修复 bug

有时候 pixiv 的搜索页面网址会出现语言标记。如下：

```
// 没有标记
https://www.pixiv.net/tags/Fate%2FGrandOrder/illustrations

// 有标记
https://www.pixiv.net/en/tags/Fate%2FGrandOrder/illustrations
```

之前的搜索页的代码没有考虑到有标记的情况，现在进行修复。

目前似乎只有语言设置为英语时会出现 `en` 标记。但也不是所有页面都会出现，现在测试了会出现 `en` 标记的页面有：

```
0
1
5
```

- 优化代码

把删除作品功能独立成了一个类。

InitPage 时指定了各自页面里抓取器的类型，这样不用把抓取器的所有属性都一股脑写到 CrawlPageBase 里面了。但是现在指定类型的方法似乎不够优雅。

## 3.2.0 2019-11-24

- 加快搜索页面抓取速度

搜索页面从单个抓取改为 10 线程同时抓取。

抓取作品信息也从原本的 6 个线程改为 10 线程。

- 代码优化

## 3.1.1 2019-11-22

优化下载器。

- 优化抓取流程

之前在作品页内向前、向后下载时，是先抓取当前 id 的信息，然后从中找到下一个要抓取的 id。像一条线一样依次抓取，每次都获取下一个 id。这导致了一个问题，如果某个页面抓取出错了，整条线路就断了。

这个抓取方式其实是历史遗留问题，早几年 p 站的作品页还是需要切换加载的，而且也没什么 API。现在对这部分抓取做了调整，在下载开始前一次性获取所有要抓取的 id，使得抓取流程不再怪异，也不怕某个页面抓取出错了。

抓取作品信息时，请求的并发数从 6 加大到了 10。这会使抓取速度有一定的提升，但是

- 图标改成 svg

这样更容易控制图标大小和颜色。

- 其他优化

## 3.1.0 2019-11-21

- 修复 bug

修复了首页输入 id 抓取失效的问题。

修复了日志输出文本里的 `<br>` 失效的问题。

- 其他优化

优化了 API。一些之前直接传 url 的地方，改成了传参数。

优化了标题状态变动，减少重复调用的地方。

“新人排行榜“也支持“抓取首次登场作品”了。

## 3.0.9 2019-11-20

- 适配搜索页改版

搜索页 url 改了，进行了适配。

- 优化快速筛选

当有多个标签同时搜索时，p 站现在默认是严格匹配，导致出来的结果很少，例如“Fate/GrandOrder 10000users入り”只有 14 个结果。所以我在快速筛选上添加了宽松匹配标记 `s_mode=s_tag`，像以前那样显示更多搜索结果。

- 修复 bug

如果搜索页面有 1000 页内容，之前只能抓取 999 页，这是因为一处判断写的不对。现在修复。

- 优化日志功能

当开始下载时，自动清空上一次下载的日志，避免日志堆积太长。

追加日志从 innerhtml 改为 appendchild，以优化性能。（感谢 Reinford0）

- 代码优化

优化 API 类。（未完成）

## 3.0.8 2019-11-19

- 抽象出了过滤器

过滤作品时不需要一个一个的调用函数检查了。现在把要审查的条件汇总起来，发送给过滤器审查即可。

- 优化了获取页面信息的操作

之前当切换页面时，之前页面的标记在新页面里没有，但是这个标记没有被清除。现在每次获取信息之前都会重置，修复了这个问题。

- 优化了文件名生成逻辑

之前存在一个问题，页面切换后，page 部分的命名标记的值会替换成新页面里的，但我们应该使用的抓取开始时的信息。如果切换了页面就使用新信息，会产生错误的结果。现在对此问题进行了修复。

解决办法是开始抓取时把页面信息储存在 store 里。

- 修复了用户 id 有时获取错误的问题

当从搜索页点击某个作品，无刷新进入作品页面后，抓取作品时发现用户 id 错误。这是因为页面网址变化时，下载器要去获取用户 id，但此时页面内容还没变，过一会儿才会变，这时就会获取到错误的 id。

解决办法是开始抓取时，再获取一次页面信息。

这样修改之后，一个页面里可能有多次 getPageInfo：页面切换时一次，之后每次开始抓取时也会产生一次。第一次可能是错误的，但不重要，它的作用是让下拉框添加有值的字段。后面的请求是正确的。

## 3.0.7 2019-11-15

- 优化了重试机制

现在抓取列表页出错时也会重试了。

不过只对那些需要抓取多次的地方做了重试（需要抓取多次才能获取所有作品的列表时）。某些只需要抓取一次的地方没有重试，因为只抓取一次就出错的概率不高，遇到了的话手动刷新一下吧。

到现在为止，抓取列表页——抓取作品详细信息——下载文件，这一整套流程都有了重试机制，稳定性有所提升。

- 优化快速筛选功能

新的搜索页面可以无刷新切换 tag，之前快速筛选只会打开第一次加载页面时的 tag，如果后面 tag 变了，快速筛选没变，就很不合理。

现在改成了实时获取 tag，并且可以保留当前页面的 mode 字段。

- 记录

今天发现 p 站搜索页，一页显示的数量从 48 个增加到了 60 个，这样我们可以抓取到更多的作品了。

## 3.0.6 2019-11-14

- 修复更新提示中，商店网址错误的问题

## 3.0.5 2019-11-13

- 重新上架谷歌应用商店

因为担心继续用之前的名字，会通不过审核，所以改了名字：Powerful Pixiv Downloader。

删除了清单文件的 key 字段。一方面是上架扩展需要删掉它，另外它似乎也会导致 Chrome 重启后，离线安装的这个扩展被删除，需要重新加载。

通过商店审核后，在程序内增加了一些提示，修改了 wiki 和官网里安装部分的说明。

## 3.0.4 2019-11-12

- 修复快速筛选在其他页面显示的问题

上个版本的修改导致快速筛选选项在切换到其他页面时也显示。现在修正这个问题。

## 3.0.3 2019-11-12

- 优化日语文本

感谢 **光の軌跡** 改进日文翻译。

- 适配“大家的新作”页面

- 修复 bug

修复了筛选必须的 tag 的结果错误的 bug。

修复了抓取作品时设置 ajax 请求数会出错的 bug。

修复了连续使用快速筛选时，快速筛选标签一直累加的 bug。

发现页面的 class 变了，适配之。

- 一些优化

搜索页面“设置页面数量”的默认值，从 -1 改为了 1000（意思是下载所有页面），方便用户理解。 -1 依然可以使用。

但是有些页面的页数/个数是无法预先知道的，不适合用明确的数字，仍然用“-1”作为标记比较好。

修改了快速筛选的插入位置，使它能够稳定在顶部出现。之前因为 p 站页面动态加载，有时它显示的位置是异常的。

关注的新作品，大家的新作品 页面里，都添加了跳转到 R18 版本的链接。

## 3.0.2 2019-11-10

- 修复 bug

修复了 [收藏夹的“未分类”功能下抓取不到图片](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/39) 的问题。这是因为重构导致对 tag 多包装了一层 encodeURI 导致的。实际上这影响了所有非英文标签，现在修改。

## 3.0.1 2019-11-08

- 修复 bug

修复了转换 gif 失败的 bug

修复了用户在自己作品页时，快速收藏出错的问题（因为这种情况不会有收藏按钮）

修复了 pixivision.net 初始化时恢复配置失败的 bug

修复了中间面板的 html 缺少结束标记的问题

- 优化扩展

上个版本把日志区域添加到 body 前面去了，修正

把 css 加载放在了 content_scripts 里

去掉了 background.ts 里设置 referer 的部分，经过测试发现它现在没有必要了

给清单文件添加了 key，这样如果扩展有多个拷贝，加载之后只会在扩展管理里显示最新的那个，而不是每次加载都生成一个扩展。

感谢 **Reinford** 的帮助！

## 3.0.0 2019-11-08

- 重构代码

之前的代码是面向过程编程，按照业务流程编写一个个的函数来解决需求。

现在尝试改为面向对象，抽象出一些类。

目前重构尚未完成，但是 p 站最近改了很多地方，所以只好先发布。

- 适配新版搜索页

由于新版搜索页不显示收藏数了，所以之前按收藏数过滤的功能不好实现，砍掉了。很可惜，不知道以后 p 站会不会加上收藏数。

- 修复了若干 bug，引入了若干新 bug

- 指导规则

1. 抽象类
2. 拆分成小的类
3. 函数做了多件事的，拆分
4. 使用异常替代返回错误码或者 false，避免后续判断。
5. 使用依赖注入解耦。

## 2.7.6 2019-10-15

- 优化命名规则

之前把一些特殊字符（标点）替换成下划线 `_`，现在会把它们替换成对应的全角的字符，使用起来更方便。

``` 
\   ＼
/   ／
:   ：
?   ？
"   ＂
<   ＜
>   ＞
*   ＊
|   ｜
~   ～
.   ．
```

**注意：**
1. 点 `.` 的替换只限于路径首尾，文件名中间部分是可以有点 `.` 的。 
2. 命名规则里的斜线不会替换（`/` 到 `／`），因为这是作为（路径）文件夹分隔符的。
3. 斜线的前后不能有空格，因为这样前后两部分是两个路径，路径的开头结尾不允许有空格。现在本程序会自动去掉路径首尾的空格。

即使像下面一样的命名规则也不会出错：

```
/\ / : ? " < > * | ~///"   *{id}-| /?~{user}> * | -{tags_translate} ? " /
```

- 优化交互体验

现在鼠标经过界面上的按钮，按钮样式会有一些改变，增加舒适度。

## 2.7.5 2019-10-13

- 优化日志功能

修复了一些颜色不对的地方

在日志上显示下载进度

转换文件时显示提示，避免分不清是在转换还是卡了

- 修复 bug

2.7.3 版本使用的变量 taskBatch 有个问题，刷新页面后重新从 0 计算。如果下载时刷新了页面，后台储存的标记是 0，刷新后再下载又是 0 ，就会被认为是重复下载，导致下载无法继续。现在修复这个问题。

- 隐藏一些广告

隐藏 tag 搜索页的广告位

## 2.7.4 2019-10-09

- 修复了 “给未分类作品添加 tag” 功能

之前一次获取 999999 个未分类作品，进行处理。现在 p 站改了，一次只能获取 100 个，需要多次获取。修复了因此引发的问题。

- 优化了输出日志的功能

支持颜色，使用起来更加规范，加强代码的可维护性。在此过程中优化了一些文本。

- 添加后台的错误处理

当 Chrome 后台下载失败时，向前台返回消息，输出错误信息。之后前台会尝试重新下载。

- 加强检验

在首页输入 id 下载时，用 Set 结构过滤掉重复的 id

## 2.7.3 2019-10-08

- 优化下载流程控制

感谢 [Reinford0](https://github.com/Reinford0) 的帮助和测试。

因为前后台通信的延迟不稳定，有时可能超过 1 秒，所以在处理遗留任务时，不再依赖前后台通信来解决，而是在后台储存任务列表。如果前台发送的任务在后台已有记录，则不进行处理。这样就杜绝了多次下载同一个文件，以及因此引起的弹框问题。当前台重新开始下载时（多次下载，或者停止后重新开始），后台重置任务列表。

去掉了上个版本增加的延迟。

对动图转换之前，也会判断任务状态，避免不必要的转换。

- 优化界面

把中间部分的按钮从 div 改成了 button，可以 tab 到了。

## 2.7.2 2019-10-04

- 优化文件名截断处理

在 chrome 77 版本中测试，发现 chrome 会自动把超长的文件名截断，这样能尽可能地让文件名使用更多的字符，非常不错。所以本程序不再对文件名进行截断了，而是交给 chrome 处理。

另外，如果设置了创建文件夹，那么文件夹的长度对文件名是有影响的。尽量不要让文件夹长度超长（不过本来也很少会超长就是了）。

chrome 是不会截断文件夹名的。

1. 如果文件夹名字的长度没有超长，chrome 会先建立文件夹，之后把文件名截断到可用的最大长度，正常保存。
2. 如果文件夹名字的长度超长，会导致 chrome 无法创建文件夹（如果有多层文件夹，chrome 先尝试正常创建文件夹，直到某一层无法创建为止）。之后 chrome 会弹出另存为对话框，定位到 chrome 的下载目录，让用户保存文件。这时候 chrome 会把文件名截断到 255 长度（如果没有超出 255 则不截断），而不是截断到实际可用的最大长度。这时候能不能保存成功就看文件名实际有多长了。

- 优化下载流程控制

这部分感谢 [Reinford0](https://github.com/Reinford0) 的帮助和测试。

现在，当用户点击暂停或者停止时，扩展后台会把后台进行中的下载任务取消掉。

这样，不需要在前台识别遗留任务了，流程更加简单不易出错，而且，这也很大程度上避免了弹出另存为对话框的问题。

弹框问题是 chrome 77 出现的，两次下载同一个文件时，如果完成的时间间隔很短，可能会弹出另存为对话框，而不是预期的覆盖文件。猜测是这时两个文件都没保存完，也就没法覆盖了，但它们却是同名的，所以就弹框让用户处理。以前版本怎么没有这个问题呢。

为了更加彻底的杜绝弹框，这次更新还把之前去掉了的 canStartTime 加回来了，就是在暂停、停止之后，过一段时间才允许点击下载按钮（现在是 500 ms）。这样把时间间隔加大，就不会容易出现弹框了。

## 2.7.1 2019-9-30

- 代码优化

`getQuery` 函数查询 url 里的搜索字段，之前是自己编写的方法，现在使用 js 的 URL 对象查询。

- 添加一些提醒文字

提醒命名规则里一定要带 id。有的人没有使用 id，只是用序号，导致文件名重复，互相覆盖。

提醒 id_num 标记的特点，每个作品都会重新计数。

## 2.7.0 2019-9-29

- 修复 bug

新版 url 可能含有语言标记，如

`https://www.pixiv.net/en/artworks/77019145`

之前没发现这个问题，会导致看图器加载失败，现在修复。

- 新增 {type} 标记

新增 {type} 标记，保存作品类型（illustration、manga、ugoira）。

- 加大了命名规则输入框的宽度

## 2.6.9 2019-9-27

- 修改 css

修复不显示“其他作品”区域的问题

## 2.6.8 2019-9-27

- 修改 css

前段时候加了对元素 `.jkOmHE` 的屏蔽，隐藏它的广告。现在这个 class 被用到头像区域了，导致头像区域被隐藏，现在去掉对它的屏蔽。

## 2.6.7 2019-9-24

- 修复 bug

修复了上个版本没有在新版页面启用图片查看器的错误

- 优化命名规则

## 2.6.6 2019-9-24

- 适配作品页面新的 url 格式

现在新版 url 格式如下：

`https://www.pixiv.net/artworks/76898963`

- 优化重试功能

之前，重试功能在有多个下载进程同时出错时（如断网），可能导致用户手动的暂停和停止不能停止重试。现在修复这个问题。

- 修改了头部注释

## 2.6.5 2019-9-23

- 修改安全文件名的规则

1. 去掉了对单引号 `'` 的替换。之前有段时间，chrome 不允许它用作文件名，现在测试可以了，所以不再屏蔽它。
2. Reinford 测试出了不允许做文件名的字符，这次都添加进去，希望以后不会再被特殊字符所困扰。

- 修改了右侧下载按钮的样式

把背景从纯色改为了渐变。

## 2.6.4 2019-9-23

- 支持了未登录时的下载

pixiv 最近支持了未登录也可以查看很多页面。我看到公告后支持了一下，目前支持未登录时，下载作品页内、作品列表页、排行榜、tag 搜索页。但是 tag 搜索页未登录时不显示收藏数，所以按收藏数筛选必须设置为 0。

- 添加向前下载功能

以前在作品页内，只能从本页向后抓取，这次添加了向前抓取功能。

- 修复了在手机浏览器上使时，下载出错的问题

[issues 26](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/25)

- 上线了官网

[https://pixiv.download/](https://pixiv.download/)

## 2.6.3 2019-9-20

- 优化了重试的逻辑

以前重试时，用户手动暂停、停止任务不能阻止程序继续重试。现在改为可以取消重试。

- 添加了一个特殊字符

\u0009 "	" [issues 25](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/25)

## 2.6.2 2019-9-19

- 获取作品信息出错时可以重试

如果因为网络原因（断开、超时），导致获取作品信息的请求失败，会进行重试。

getIllustData 出错时会通过 reTryGetIllustData 重试。间隔时间为 2 秒。

## 2.6.1 2019-9-18

- 更改了目录结构

优化了项目结构和打包流程

- 添加检测更新功能

因为现在从应用商店下架了，所以在 GitHub 上发布，并使用 api 检查更新。

- 修复 bug

上个版本的修改导致从 pageType 1 进入 2 时出错，现在修复。

## 2.6.0 2019-9-17

- 优化文件名截断处理

对于带文件夹的文件名，本程序会将文件夹和文件名的字符合到一起计算长度，如果长度超过 200，则截断。

但是快速下载时，有时是不需要创建文件夹的，此时应该只计算文件名的长度。之前这里仍然计算了文件夹的长度，现在我发现了这个问题，修复之。

有时候文件名长度并没有超过 200，但是加上文件夹长度超过了 200，导致文件名被截断。很可惜。

## 2.5.9 2019-9-16

- 新增功能

排行榜页面可以设置下载前多少张，并且增加了 {rank} 命名标记保存作品的排名。

## 2.5.8 2019-9-16

- 新增功能

可以下载自己书签页面下方推荐的作品。只下载已经加载出来的。

目前的观察，当没有选择 tag 的时候，最多会加载 100 个。如果有选择的 tag，最多会加载 500 个。目前根据用户的需求，只下载页面上已经加载出来的，而不是下载从 api 获取的全部作品。

下面是从 api 获取数据的代码。

```
// 从包含数据信息的元素中匹配
const element = document.querySelector(
  '.layout-column-2>script'
) as HTMLScriptElement
// 取出 sample illust 列表
const text = element.innerText.match(/"(.*?)"/)!
const sampleIllusts = encodeURIComponent(text[1])
// 拼接请求的 url
const url = `https://www.pixiv.net/rpc/recommender.php?type=illust&sample_illusts=${sampleIllusts}&num_recommendations=100`
// 发起请求
const response = await fetch(url)
if (response.ok) {
  const recommendations: Recommendations = await response.json()
  const idList = recommendations.recommendations
}
```

- 修复 bug

1. 修复了下载收藏的“未分类”标签时，下载的是所有书签作品的 bug。  [issues 24](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/24)
2. 修复了重复抓取时可能把 title 错误截断的问题。

- 优化体验

之前下载停止后，如果仍然有下载到文件，已下载数量会从 1 开始算，看起来觉得诡异。现在优化此处，停止时不清空之前的下载数量。

## 2.5.7 2019-9-15

- 修复 bug

有的图片的静态图是 gif 后缀的，会被扩展当作要转换成 gif 图片，导致出错。现在修复了这个 bug。测试 id 76764342。

## 扩展被下架 2019-9-13

2.4.0 里，加了一个功能，如果当前页面不是 p 站页面，则打开 p 站页面。但之后被 Google 人工审核，判定扩展违法，被下架。

之后我去掉了这个跳转功能，重新发布扩展，但又被下架。并且我的开发者账户也被停用。

到底是什么意思呢？我搞不懂了。

两次通知邮件的内容一模一样，都是例行公事的那种，并没有提到具体是哪部分的问题，我也没有途径和他们取得联系。

> Your item did not comply with the following section of our policy: We don't allow content that contains nudity, graphic sex acts, or sexually explicit material. We also don't allow content that drives traffic to commercial pornography sites. Google has a zero-tolerance policy against child pornography. 

翻译：

> 您的商品不符合我们政策的以下部分：我们不允许包含裸露，图片性行为或露骨色情内容的内容。我们也不允许内容为商业色情网站带来流量。谷歌对儿童色情制品采取零容忍政策。

扩展本身是没有任何色情内容的。如果说下载 pixiv 内容就是色情行为，为什么其他 pixiv 下载器都没事呢？

反正，我已经不想再和谷歌折腾了。它爱咋样就咋样吧。

## 2.5.6 2019-9-13

修复 bug   [issues 21](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/21)

## 2.5.5 2019-9-12

- 屏蔽了一些广告
- 减小了重试下载的时间间隔（现为 1 秒）
- 修改了对图片 url 的权限

之前匹配的图片 url 是 `i.pximg.net`，但今天发现有些人的前缀不是 i，而是 `tc-i`，所以修改了此处。

## 2.5.4 2019-9-11

- 代码优化

优化了一些代码逻辑，并修复了一个存在了很久的 bug。

这个 bug 以前的表现是：点击暂停后快速点击开始，这样下载完后可能会发现有一些图片漏下。越是多次这样操作，漏的图越多。

之后我加了延时，暂停后过一段时间才允许点击开始，其实也能杜绝这个现象，但这终究只是“治标”。

今天又想到这个地方，想通了问题在哪里：

以前，当一个文件下载完成后，downloaded + 1。然后根据 downloaded 判断是否全部下载完成。

但是用户暂停了任务时，有的任务处于【已经接收完文件，发给浏览器下载，但还没有最终下载完成】的状态中，还没有增加 downloaded。

在这个过程中，用户又点击了开始，这些未完成的任务又要下载。新一轮的下载中，刚才那些还没下载完成的任务下载完了，downloaded + 1。但新一轮里又把它们下载了一次，downloaded + 2。

也就是说，一个这样的任务就会导致 downloaded 增加 2。这样的 downloaded 是错误的，当程序判断 downloaded 等于要下载的文件数量时，认为任务下载完毕了，但其实这样的任务占用了两倍的次数，实际上文件并没有下载完，最终表现为漏下。

以前加的延时是 2.5 秒，大于【从接收完文件，到浏览器下载完】的所需时间，所以解决了问题。但最近的版本加了转换动图的功能，接收完文件之后还要转换很久，估计这个延时在这种情况下又会失效。

现在从根本上解决了问题，不是每次下载完之后 downloaded + 1，而是根据下载任务的状态列表计算 downloaded。因为多次下载同一个文件，在状态列表里计算也只是一个，不会导致 downloaded 增加多次。这也体现了状态列表的重要性。

## 2.5.3 2019-9-9

- 代码优化

优化了一些代码逻辑，进行了一些解构。

- 修复 bug

2.5.0 版本修改标题时，一处正则是贪婪匹配，现在修正。

// mode=big 类型在 pc 端可能已经消失了，但是移动端查看大图还是big https://www.pixiv.net/member_illust.php?mode=big&illust_id=66745241

- 重新在应用商店发布

之前版本因为跳转到 p 站的功能被下架了，只能重新发布。导致安装页面的 url 也变了。

## 2.5.2 2019-9-8

- 去掉打开 pixiv 页面的功能

2.4.0 里，加了一个功能，如果当前页面不是 p 站页面，则打开 p 站页面。但之后被 Google 人工审核，认为此行为是把流量导航到色情网站，判定扩展违法。

现在去掉这个功能。

## 2.5.1 2019-9-8

- 修复 bug

优化了对零宽字符的替换处理。[issues 20](https://github.com/xuejianxianzun/PixivBatchDownloader/issues/20)

## 2.5.0 2019-9-6

- 新增功能
  
批量下载动图时转换为 gif。

- 修改文本

设置作品类型 改为 下载作品类型。

- 修复 bug

修正了设置 title 是导致的一处问题。设置 title 时尽量使用的是 og:title，但是有些页面上，og:title 的内容和实际的 title 不一致，这时候就不能用 og:title。

- 修改下载线程数限制

最大下载线程数限制从 10 下降到 5 了。这是因为最近加了动图的转换功能，如果同时转换很多文件，资源占用太大。为了防止一些人不懂得减小线程，所以做此修改。

## 2.4.2 2019-9-6

- 修复bug

2.4.0 版本把宽高比的输入值用 parseInt 解析了，导致出现 bug，现在进行修正。

## 2.4.1 2019-9-6

- 优化了在 title 上添加提醒的代码

优化了此部分的逻辑。但是有了新的问题。之前用了一个变量保存旧标题，切换页面后可以保持标题不变，但也会导致标题一直是旧标题。现在修改后去掉了这个变量，所以切换页面之后，标题会变成新页面的标题。下载途中切换页面就会导致标题变成没有提醒的了。

- 修复了 pageInfo 的 bug

上个版本造成了 bug，现在修复，并优化这部分的逻辑。

命名

## 2.4.0 2019-9-5

- 使用了 typescript
- 点击扩展的图标时，如果当前页面不是 p 站页面，则打开 p 站首页
- 之前把 viewerjs 的 js 文件和 css 文件混合了，现在拆分开。
- 修改了一些代码

## 2.3.1 2019-8-30

略微优化了文本和样式。

## 2.3.0 2019-8-29

- 新增 {date} 命名标记

作品的创建日期，格式为 yyyy-MM-dd。如 2019-08-29

- 多图作品设置 改为 设置作品张数

相应的也把设置里的变量名改了（xzSetting.imgNumberPerWork），如果是之前版本升级上来的，没有这个属性，则设置为默认值 0.

- 改善下载逻辑

下载时，文件接收完成之后还要一段延迟时间才会让浏览器下载，浏览器下载完成又要一段时间。之前，如果在这两个时间段里停止了任务，还是会继续下载已经就绪的文件，以及显示下载进度。现在优化了这部分的逻辑。

- 代码优化

优化了一些变量名和代码结构。

## 2.2.2 2019-8-28

有用户报告说 pixiv 有一些图片的源文件可能损毁了，图片是 404 的。例如：

[id=34152007](https://www.pixiv.net/member_illust.php?mode=medium&illust_id=34152007) 

[id=51449700](https://www.pixiv.net/member_illust.php?mode=medium&illust_id=51449700) 

以前没遇到过这个情况，这会导致下载器卡住、不停的重试。现在针对这种情况做了改进：

- 在页面顶部的输出信息里添加提示
- 创建一个 txt 后缀的文件，内容是提示这个文件不存在。

## 2.2.1 2019-8-27

- 修改了一处文字
- 略微修改下拉框的样式

## 2.2.0 2019-8-25

- 网络较差时自动重试下载

当网络状况较差时，下载可能会因为超时、断开而卡住、出错。现在本程序检测到出错时会自动暂停下载，并在一定时间后尝试继续下载（目前的设置是 20 秒）。如果问题依然存在，会一直进行尝试。

- 代码优化

1. 修复和优化暂停、停止下载时的状态变化。
2. 抽离出下载相关的方法，方便调用。
3. 删除已经无用的 timeDelay 变量。

- 修复 bug

1. 当一个下载进度条开始它的第二个下载任务，但还没有收到响应时，应该显示为初始状态。之前在这个阶段会停留在上一条任务的完成状态，现在修正。
2. 解决漏下问题。以前用 downloaded 作为下载时的索引，但这是不可靠的。网络较好的情况下没有问题，但是网络差卡住时，频繁暂停、继续下载，就会暴露出问题，导致一些图片漏下。现在新增了 downloadedList 保存任务的下载状态，修复了这个问题。downloaded 只作为已下载数量使用。（因为下载任务的完成顺序并不是按添加顺序的，假设 downloaded 为 5，而已下载的是 1、2、3、4、6，暂停后使用 downloaded 作为索引，则应该下载 6，这样就漏下了 5，重复下载了 6。

- 更新了新版本的提示。

## 2.1.3 2019-8-25

- 优化代码

1. 之前 changeWantPage 里隐藏页数设置时，没有使用 hideNotNeedOption。现在将其改为通过 hideNotNeedOption 处理。
2. 预览文件名时，之前动图的左侧不是原文件名，现在修正。这样是为了方便用第三方下载器的用户下载后，用预览文件名的结果进行重命名。不过修改后 pixivision 里预览时左侧可能会有一些后缀名与真实后缀名不符，暂且忽略。
3. 之前计算文件的体积时，是把字节数除以 1000 作为 KB，现在改为 1024。并且小数部分的处理改为向下取整，因为 Windows 在显示 100 KB - 1 MB 之间的文件的体积时，就是向下取整的（如计算结果时 119.66 KB，Windows 显示为 119 KB），为了保持一致本程序也向下取整。
4. 当下载暂停或停止时，使用 `xhr.abort()` 中断下载请求。之前没有中断，网络请求其实是在继续的。
5. 两次下载任务之间需要一定的间隔，现在优化了此部分的逻辑，并且把间隔值 time_interval 调小。效果表现为略微加快了建立任务的速度。
6. 抓取页面时的并发连接数从 5 增加到 6，并且取消了每个请求中间的间隔。
7. 优化了给未分类作品添加 tag 时的逻辑，改为单线程依次添加（之前的方式可能造成网络堵塞）。
8. 取消了一些不必要的 setTimeout 定时器。
9. checkWhatIsNew 只在 pixiv 检查，避免在 pixivision 也会弹出一次。

- 优化文本

1. 抓取部分的按钮里的“下载”改为“抓取”，避免用户理解上的困扰。
2. 英文的“输入”从 enter 改成 type。
3. 删除已经不再使用的文本。

- 疑问

Chrome 的 HTTP 并发连接数最大为 6，但是当下载线程大于 6，比如设置为 10 的时候，看 network 面板似乎也是可以同时进行的？

## 2.1.2 2019-8-18

- 优化一些样式

优化了一些布局问题。之前一些英文、日文按钮因为文字较多会产生换行，导致按钮的高度不一致，很难看。现在使用 flex 调整布局。

- 日文的下载控制按钮文字翻译为日文

原本因为日文太长用的是英文，如“pause download”，现在改成日文。但是日文好长啊。

- 折叠面板的两个三角形对调回去了。

- 更新了 readme 里的截图。

## 2.1.1 2019-8-16

- 修复 bug

上次的修改出了 bug，因为 getIllustPage 里的 illustType 是数字，其他 api 里的是字符串。上次修改时把这里当成了字符串判断，导致动图下载异常，现在修复。

## 2.1.0 2019-8-15

- 调整了主面板上各个选项的顺序

按照功能分类和使用频率，重新排列了一下选项的上下顺序。

- 记忆了折叠设置

主面板右上角的三角形可以折叠/展开选项区域，因为有用户想要记住设置，现在记忆了这个选项。

顺便对调了两个三角形。

## 2.0.0 2019-8-15

- 修改排除作品选项

以前“下载作品类型”的选项是“单图、多图、动图”，现在改为“插画、漫画、动图”。

- 新增命名字段 {tags_translate}
 
有一些 tag 后面跟的有翻译后的 tag。使用 {tags_translate} 命名规则，会自动在原 tag 后附加翻译后的 tag（如果有的话）

- 新增 what`s new 提示

如果版本更新时需要对用户进行一些提醒，可以在lang.js 里添加一条提醒，并把 whatIsNewTag 设置为这个键值。

- 优化抓取流程

在多种页面类型里，在抓取列表页阶段直接检查一些设置，尽量避免抓取到不需要的作品。

- 其他优化

解耦了一些函数，优化了多处代码，优化了一些逻辑，消除了一些 bug。

加大了中间面板的层级，避免被某些页面内容挡住。

- 版本号顺延到 2.0.0

最近频繁的进行了一些修改和优化，版本号也走到了 2.0.0。以前的努力，全部没有木大，所以说，不要停下来啊！

## 1.9.3 2019-8-13

- 优化排行榜页面的抓取效率

在抓取列表页时直接检查宽高和宽高比设置，避免抓取到不需要的作品。

- 优化代码

之前一些使用中括号来引用对象属性的代码，现在改成点 `.` 的写法。

一些可以用 dataset 获取的 DOM 属性都改成了用 dataset 获取。（之前有的是用 getAttribute 方法获取的）

- 发现了一个小问题

当进入自己的收藏页面时，本程序隐藏了“只下载已收藏”选项，因为自己的收藏页面里都是已收藏的作品，这个选项没有意义。

但是因为没有区分自己的收藏页面和别人的收藏页面，所以如果直接进入别人的收藏页面，也会隐藏这个选项。如果之后再切换到这个人的“插画”、“漫画”页面，也不会显示这个选项。（因为这些页面的切换是无刷新的）这时就不正常了，因为在“插画”、“漫画”页面应该显示出这个选项。

但是这个问题很少发生，因为一般都是直接进入别人的主页，或者插画分类页面，不会直接进入别人的收藏页面。如果发生了这个情况，刷新一下页面即可解决。所以此问题目前并未处理。

## 1.9.2 2019-8-9

- 在排行榜页面，增加了 “只要首次登场” 按钮

只下载首次登场的作品

- 在排行榜页面，优化抓取流程

在抓取列表页时可以获取 tag，所以在这里就检查了一遍 tag，避免抓取到不需要的作品，浪费之后第二次检查的时间。

## 1.9.1 2019-8-6

- 考虑到转换动图会消耗较多的资源，将默认的下载线程数从 6 降低到了 5。
- 之前在 pixivision 忘记隐藏动图保存选项了，现在隐藏它。
- 隐藏了一处广告。

## 1.9.0 2019-8-6

- 添加了将动图批量转换为 webm 视频的功能。  
  可以设置将动图保存为 webm 视频还是 zip 源文件。取消了之前单个转换成 gif 的方式。
  添加了相应的设置项。
  踩了好多坑，花了好多时间 Orz

- tag 筛选不再区分大小写了

- tag 搜索页在筛选阶段也可以应用 tag 筛选的条件了

- 优化了扩展的文件结构，独立出了语言配置文件

- 优化代码，修复 bug

## 1.8.6 2019-8-1

在界面上加入了 wiki 的链接。

## 1.8.5 2019-7-31

- pixivision 的默认命名规则加上了文件夹部分  
  pixivision 的规则原本只有 {id}，没有文件夹部分，现在加上了默认的 {p_title} 作为文件夹名。

- 代码优化  
  优化了部分变量名；
  取消了发现页面的 “清空作品列表” 的按钮。

## 1.8.4 2019-7-30

- 完善了下载“相关作品”的功能

  这个相关作品指的是作品页面最底下的相关作品，最多有 180 个。以前下载相关作品时，实际上走的是 pageTpye 9 的流程，这样获取的数据和作品下面的并不一致，只有一部分会是一样的。现在改成和作品下面的完全一致了。

  不过有个缺点，就是之前的方法可以获取很多个相关作品（甚至 1000 个），但现在由于作品下面是固定的 180 个，所以最多也只能下载 180 个。

  相关作品列表的排列大致上算是按 id 从大到小排列，新的显示在上面。不过也并不严格，比较混杂。

  当用户设置了只下载一部分时，本扩展会把 id 列表页从大到小排列，截取最前面的一部分。我严格了，p 站自己不严格，没办法。

## 1.8.3 2019-7-29

- 放弃对 Firefox 的支持  
  在 1.3.0 版本由 z2n 添加了对 Firefox 的支持，而在最近的 1.8.0，因为一些修改，不支持 Firefox 了。我发现这个问题之后，进行了探究，结论是，由于本工具的下载机制，与 Chrome 相比，在 Firefox 下载是低效率、高资源占用的。经过一番思索后，我没有恢复 Firefox 的支持，希望大家使用 Chrome 带来更好的使用体验。

  这和 Firefox 的安全策略有关，我来解释一下原因：

  在前台页面下载到了图片的数据，是 Blob 对象，之后生成一个 blob url，发送给后台下载。这个 Blob URL 类似于这样：

  ```
  blob:https://www.pixiv.net/3424182d-6c92-4307-a88e-ef9c302c9b90`
  ```

  Chrome 可以正常下载，Firefox 却报错，因为安全原因不允许下载。Firefox 要求这个 url 是要在后台页面生成的才行。

  问题来了，要在后台页面生成 url，首先要把图片数据传给后台，但给后台传递的消息是 JSON 对象，blob 对象无法直接传递，只能转换为 Base64 再传给后台，后台再换换成 Blob，生成 Blob URL 下载。

  所以，为了传递这个数据到后台，**在 Firefox 上要把 Blob 先转到 Base64，后台再转回 Blob**。这一套左右横跳不是没有代价的，内存和 CPU 资源占用都将极大增加。下载速度稍快，用户操作电脑就会感到明显的卡顿。之前支持 Firefox 的时候就是这样的，所以现在我也不打算恢复了。别问，问就是 Chrome 体验更好。

  Chrome 上：

  Blob 对象 → Blob URL → 后台 → 下载

  Firefox 上：

  Blob 对象 → Base64 → 后台 → Blob 对象 → Blob URL → 下载

  太蛋疼了。

- 修复 bug

  修复了第一次点击扩展图标时，中间区域应该显示却没有显示的 bug。

- 文件的换行方式都换成 LF

  我本地的代码和 GitHub 上的代码统一了换行方式。之前本地代码文件是 CRLF 换行方式，现在改成 LF。这一点在 GitHub 看不到区别，因为 Git 会自动把提交的文件的换行方式改成 LF。

## 1.8.2 2019-7-28

- 优化代码 ？

这次更新把 css 样式从代码中抽离成了单独的文件，在代码中通过网络请求引入。这个地方就很奇怪，在画师页面、作品页面等无刷新加载的页面里，加载样式文件只需要 20 ms 左右，然而在其他页面里，可能需要高达 200 ms。加载样式时代码是停止执行的，所以我这次代码优化算不算是优化？

本来我还打算把语言配置单独保存成未见，看来加载的延迟是个问题，语言配置就先不改了。

## 1.8.1 2019-7-28

- 修复 bug  
  修复了从画师主页、列表页、书签页进入作品页时，图片查看器有时不能使用的 bug。

- 优化代码  
  gif、zip 库的 worker 文件通过 fetch 引入了，不在硬编码到 content.js 里了。

## 1.8.0 2019-7-26

- 代码修改成 standard 风格  
  变量名都变成了驼峰命名规则，所以之前用户设置过的选项需要重新设置。

- 优化了下载时的资源占用  
  之前下载时，会把图片数据从 blob 转换到 base64，再转换到 blob。现在没有这个转换过程了，CPU、内存资源占用将会大幅下降。

- 修复了一些 bug  
  修复了 puser 在某些情况下获取错误的问题。

- 完善了注释

- 下载书签作品时会倒序下载  
  之前也有一些对下载顺序的处理。画师的列表页里，会按 id 从大到小下载，这样可以先下载最新作品，后下载早期作品。tag 搜索页里则是按收藏数从高到低下载（都是通过 sortByProperty 对数据进行排序的）

- 移除了 url 里包含 recommended.php 的情况，它是首页的“为您推荐”栏目，现在已经被“发现”页面取代了。

- 加粗提示了文件名乱码的问题

近期打算写个 wiki。

## 1.7.3

p 站代码又变了，获取画师名的代码做了相应的修改。现在其实是更简单了，挺好的。

## 1.7.2

优化了获取 token 的方式，添加 tag 的按钮可以在书签页直接出现了。之前需要先用一次快速收藏才会出现这个按钮。

## 1.7.1

优化体验。之前在一些非书签页也会显示添加 tag 按钮，现在限制在只在书签页显示。但目前有个问题，在别人的书签页里也会显示。

## 1.7.0

在书签页面，可以给“未分类”的书签批量加上 tag。这样可以节省大量的时间。

## 1.6.8

快速下载时，如果只有一个文件，则不建立文件夹。如果大于一个图片，则建立文件夹。

## 1.6.7

- 优化繁体中文文本

- 修复快速收藏功能，感谢 yuzhan1990。

## 1.6.6

- 对合法的文件名的规则进行修改  
   现在的 Chrome 下载扩展 API 不允许文件名里含有 `~` 了，所以增加了对此情况的处理。  
   另外增加的 `∋\` 是一个特殊字符，有时候会遇到，它没有宽度。它会导致 chrome 下载文件时报错，文件名不合法。

## 1.6.5

画师作品列表页带 tag 时的 api 发生了变化，修改之。

## 1.6.4

- 添加了 {p_num} 标记，也就是图片的 p 数。

- 因为格式化程序的改变，函数名和括号之间增加了空格。参数列表的逗号后面也加了空格。

## 1.6.3

- css 优化

- 其实主要原因是 Firefox 扩展被下架了，补充了一些隐私政策等信息，提交新版本进行审核。

- 更新了 readme 里的捐赠信息，之前放的博客链接，但是需要翻墙才能打开。所以现在直接放图片了。

## 1.6.2

- 修复 getUserName 的 bug  
  之前从 dom 里获取，但是这样 p 站一改版就出问题，所以还是从 api 获取比较好。所以添加了 getIllustInfo 函数。虽然可能会多次调用它，但是有缓存，所以问题不大。

## 1.6.1

- css 优化

- 查看多 p 图片的页面 [示例](https://www.pixiv.net/member_illust.php?mode=manga&illust_id=67618513) 并不能进行下载，但之前显示了下载图标，现在去掉

## 1.6.0

- 增加了 id_num 命名字段

- 停止下载时添加时间间隔。

## 1.5.8

p 站最近在 tag 搜索页的 R-18 分类里，增加了广告信息，导致抓取出错，现在修复这个问题。

## 1.5.7

修复 bug

## 1.5.6

- 优化文本

- 修复 getUserName 的 bug  
  之前 getUserName 会使用 old_title，这是有问题的，不同语言的 title 不一样，导致严重错误，英语语言下完全无法下载。现在修复了。

## 1.5.5

- 修改了右侧按钮样式使其更加明显

- 添加了建立文件夹的提示

- 优化日文文本

## 1.5.4

fix the notation of some of the Japanese.

## 1.5.3

- 在 sortByProperty 里把参数都转换成了数字。  
  之前传入的参数是字符串，按首位比较的，不准确。转换成数字以保证结果准确。

- 暂停和继续下载添加定时器。  
  如果点了暂停，然后点开始继续，中间间隔时间很短，可能会出问题。所以加上了延时。

## 1.5.2

文件名标记里有些值是数字（如 bmk），导致 replace 报错 `once.replace(safe_fileName_rule, '_')`。现在统一转换为字符串，避免错误。

## 1.5.1

修改命名规则后，快速下载也会建立文件夹了。现在修改成不建立文件夹的状态。

## 1.5.0

修复动图额外建立了文件夹的问题。

## 1.4.9

添加命名规则的示例。

## 1.4.8

原样保留空字段,放到文件名里.

## 1.4.7

- 合并文件夹和文件名输入框

- 优化文件名生成逻辑

- 接受重复字段，去掉空值字段

- 优化一些文本描述和用户体验

## 1.4.5

- 修改了扩展的 logo 和应用商店的封面图。

- 增加提示：禁用其他下载扩展。

### 扩展里代码移植时产生的不同

- 互相检测使标识不同

- ex 不判断 Firefox

  合并代码之后要搜索 Firefox 删除

- ex 不判断 allowFolder

- ex 中间面板没有安装扩展的提示

  相关 css 代码也不同  
  github 的 url 不同  
  设置文件夹哪里没有“如何使用”

- ex 转换 gif 代码不同

  initViewer() 里面不同

- ex 设置 history \_wr 方式不同

- ex 获取 tt 不同

- ex 获取用户名时判断登陆的代码不同

- 下载时

  不判断 GMinfo，不使用 GM_xmlhttpRequest  
  dataurl 和 bloburl 不同  
  要单独处理这里的改动，以及 startDownload()

- ex 多了 readBlobAsDataURL()

- ex 多了 browser 相关代码

## 1.3.7

同步了脚本版的修改。

每次脚本版的大改，要再同步到扩展版里都很麻烦，因为两者的代码只是部分通用。

之前上架 Mozilla 扩展时，因为 jQuery 源代码过审没通过，遭到下架。我也想不明白是为什么。现在去掉了 jQuery，可以尝试再次上架了。

## 1.3.1

Firefox 的扩展要求提供第三方库的说明

### Third-party library used

### [viewerjs](https://github.com/fengyuanchen/viewerjs)

Viewerjs-mix.js [Javascript part](https://github.com/fengyuanchen/viewerjs/blob/master/dist/viewer.js)

Viewerjs-mix.js [CSS part](https://github.com/fengyuanchen/viewerjs/blob/master/dist/viewer.css)

### [zip.js](https://github.com/gildas-lormeau/zip.js)

[inflate.js](https://github.com/gildas-lormeau/zip.js/blob/master/WebContent/inflate.js)

[zip.js](https://github.com/gildas-lormeau/zip.js/blob/master/WebContent/zip.js)

[z-worker.js](https://github.com/gildas-lormeau/zip.js/blob/master/WebContent/z-worker.js)

### [gif.js](https://github.com/jnordberg/gif.js)

[gif.js](https://github.com/jnordberg/gif.js/blob/master/dist/gif.js)

[gif.worker.js](https://github.com/jnordberg/gif.js/blob/master/dist/gif.worker.js)

### [webextension-polyfill](https://github.com/mozilla/webextension-polyfill)

[browser-polyfill.js](https://github.com/mozilla/webextension-polyfill/blob/master/src/browser-polyfill.js)

## 1.3.0

- 感谢 [z2n](https://github.com/z2n) 对本工具做出的改进，使本工具适配了 Firefox 浏览器。

- 因为 Firefox 扩展的规定，使用的 jQuery 版本必须大于 3.0，所以升级了 jQuery 库。

- 优化了获取 token 的方式，使其更加稳定。

- Firefox 在内存占用方面的缺点：

当下载的文件数量比较多的时候，Firefox 所需的内存占用量比 Chrome 略大。

而且下载完成后，Chrome 的内存占用很快回落到一个稳定水平，Firefox 的回落速度却明显比较慢。

以上两点可能导致 Firefox 在下载大量任务时，内存占用过多导致卡死。

## 1.2.5

上个版本出现了 bug，改回上上版本的内容。

## 1.2.3

点击扩展图标可以显示/隐藏下载面板

## 1.1.3

上个版本里，把 time_interval 改小了，结果出现了问题，极少数图片会下载重复，并且重复了几个，就会有几个正常图片下载不到，就像被“挤掉了”一样。于是把 time_interval 改回去了。

**time_interval** 这个参数是半年前加上的，可参考脚本版 log.md 的 5.1.0 条目。简单来说，可能是连续两个下载任务间隔时间很短的话，会导致有一个保存不上。这个参数人为的增加了延迟。

但是很奇怪的是，当初脚本版出现这种情况会导致漏下，如今扩展版的异常不是漏下，而是变成重复了，其中原因不清楚。

我不能确定这个问题是否真的是由 time_interval 导致的。因为目前这个问题仍然偶尔出现。问题总是出在前几个作品里（10 个以内），里面有 1 或 2 个重复的，并且导致有其他作品漏下了。

最近的测试里，每批 400 张图片，下载了 4 次（1600 张），出现了 1 个重复的图片。

我觉得下载越快（浏览器处理不过来），越容易出现这个问题。解决的办法可能需要继续增加 time_interval 的延迟，或者（并且）减少同时下载的线程数。但是这样下载会变慢，暂不处理。

扩展版的稳定性一直不如脚本好，很奇怪。有时候脚本版的看图组件会加载失败；有时候收藏时自动点赞失效，奇哉怪也。

## 1.1.2

之前的下载方式和脚本版是一样的，点击 a 标签下载。现在为了能自动建立文件夹，改成了发送给 chrome 来下载。

*早期的一些版本更新没有写日志*

## 推荐更新级别

- 必要。必须进行更新，因为旧的版本已经不适合继续使用。
- 一般。如果更新内容对你有用，你可以进行更新。否则无需更新。